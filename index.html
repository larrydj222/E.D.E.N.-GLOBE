<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="dark" />
  <title>MAP E.D.E.N. — Futuristic Prototype (Index)</title>

  <style>
    :root{
      --bg:#050508;
      --fg:#ffffff;
      --muted:rgba(255,255,255,.72);
      --muted2:rgba(255,255,255,.52);
      --stroke:rgba(255,255,255,.12);
      --stroke2:rgba(255,255,255,.20);
      --glass:rgba(12,14,18,.62);
      --glass2:rgba(14,16,22,.82);
      --shadow: 0 24px 90px rgba(0,0,0,.60);
      --radius:22px;
      --radius2:16px;
      --pad:16px;

      --green:#34d399;
      --amber:#fbbf24;
      --blue:#60a5fa;
      --red:#fb7185;
      --chip: rgba(255,255,255,.08);
      --chip2: rgba(255,255,255,.12);

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --ui: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background: radial-gradient(1000px 700px at 70% 20%, rgba(96,165,250,.20), transparent 60%),
                  radial-gradient(900px 700px at 35% 60%, rgba(52,211,153,.12), transparent 62%),
                  linear-gradient(180deg, #050508 0%, #040408 40%, #050508 100%);
      color:var(--fg);
      font-family:var(--ui);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      overflow:hidden;
    }

    /* Background layers */
    .bg{
      position:fixed; inset:0;
      overflow:hidden;
      pointer-events:none;
    }
    canvas#stars{
      position:absolute; inset:0;
      opacity:.9;
      filter: blur(.1px);
    }
    .earthGlow{
      position:absolute;
      width:min(1200px,130vw);
      height:min(1200px,130vw);
      left:50%;
      top:30%;
      transform:translate(-50%,-10%);
      border-radius:50%;
      background:
        radial-gradient(circle at 55% 40%, rgba(255,255,255,.15), transparent 45%),
        radial-gradient(circle at 55% 40%, rgba(96,165,250,.14), transparent 60%),
        radial-gradient(circle at 50% 55%, rgba(96,165,250,.10), transparent 70%),
        radial-gradient(circle at 50% 65%, rgba(0,0,0,.55), rgba(0,0,0,.98) 70%);
      opacity:.75;
      filter: blur(.2px);
      mask-image: radial-gradient(circle at 50% 55%, black 10%, black 45%, transparent 65%);
    }
    .horizon{
      position:absolute;
      width:min(1200px,130vw);
      height:min(1200px,130vw);
      left:50%;
      top:30%;
      transform:translate(-50%,-10%);
      border-radius:50%;
      box-shadow: 0 -18px 60px rgba(96,165,250,.22), 0 -8px 30px rgba(255,255,255,.10);
      opacity:.55;
      mask-image: radial-gradient(circle at 50% 55%, transparent 0 36%, black 42% 58%, transparent 68%);
    }

    /* Layout */
    .app{
      position:relative;
      height:100%;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding: max(12px, env(safe-area-inset-top)) 12px max(12px, env(safe-area-inset-bottom)) 12px;
    }

    .sheet{
      width:min(980px, 96vw);
      max-height: min(84vh, 820px);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03)),
                  radial-gradient(900px 420px at 40% 0%, rgba(96,165,250,.16), transparent 60%),
                  radial-gradient(900px 420px at 70% 40%, rgba(52,211,153,.10), transparent 60%),
                  var(--glass);
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      overflow:hidden;
      position:relative;
    }

    .sheetTop{
      padding: 12px var(--pad) 10px var(--pad);
      border-bottom:1px solid var(--stroke);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .handle{
      position:absolute; left:50%; top:10px;
      transform:translateX(-50%);
      width:64px; height:6px;
      border-radius:999px;
      background: rgba(255,255,255,.18);
    }

    .titleWrap{ padding-top: 10px; }
    .title{
      font-size: 28px;
      font-weight: 800;
      letter-spacing: .04em;
      margin:0;
    }
    .subtitle{
      margin:6px 0 0 0;
      color:var(--muted);
      font-weight: 600;
      letter-spacing:.02em;
    }
    .subtitle .dot{ opacity:.55; padding: 0 6px; }
    .rightControls{
      display:flex;
      align-items:center;
      gap:10px;
      padding-top: 10px;
      flex: 0 0 auto;
    }

    .pillX{
      width:44px;height:44px;
      border-radius: 16px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.85);
      display:grid;
      place-items:center;
      cursor:pointer;
      transition: transform .08s ease, background .15s ease;
      user-select:none;
    }
    .pillX:active{ transform: scale(.98); }
    .pillX:hover{ background: rgba(255,255,255,.09); }

    .modeToggle{
      display:flex;
      gap:8px;
      padding: 6px;
      border:1px solid var(--stroke);
      border-radius: 16px;
      background: rgba(0,0,0,.18);
    }
    .modeBtn{
      border:1px solid transparent;
      background: transparent;
      color: rgba(255,255,255,.78);
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 800;
      letter-spacing:.02em;
      cursor:pointer;
      transition: background .15s ease, border-color .15s ease;
    }
    .modeBtn.active{
      background: rgba(255,255,255,.08);
      border-color: var(--stroke);
      color: #fff;
    }

    .navGrid{
      padding: 12px var(--pad) 12px var(--pad);
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      border-bottom:1px solid var(--stroke);
      background: rgba(0,0,0,.12);
    }

    .navBtn{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      padding: 14px 14px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      color:#fff;
      font-weight: 900;
      letter-spacing:.02em;
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      min-height: 52px;
    }
    .navBtn:hover{ background: rgba(255,255,255,.07); border-color: var(--stroke2); }
    .navBtn:active{ transform: scale(.99); }
    .navBtn .lamp{
      width:12px;height:12px;border-radius:999px;
      background: rgba(255,255,255,.14);
      box-shadow: 0 0 0 3px rgba(255,255,255,.06);
      flex:0 0 auto;
    }
    .navBtn.active .lamp{
      background: var(--green);
      box-shadow: 0 0 0 3px rgba(52,211,153,.14), 0 0 18px rgba(52,211,153,.35);
    }
    .navBtn.danger .lamp{
      background: rgba(255,255,255,.14);
    }
    .navBtn.danger.active .lamp{
      background: var(--red);
      box-shadow: 0 0 0 3px rgba(251,113,133,.12), 0 0 18px rgba(251,113,133,.22);
    }

    .content{
      display:block;
      padding: 14px var(--pad) 14px var(--pad);
      overflow:auto;
      max-height: calc(84vh - 220px);
      scrollbar-width: thin;
      scrollbar-color: rgba(255,255,255,.16) transparent;
    }
    .content::-webkit-scrollbar{ height:10px; width:10px; }
    .content::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.14);
      border-radius: 999px;
      border:2px solid transparent;
      background-clip: padding-box;
    }

    .panel{ display:none; }
    .panel.active{ display:block; }

    .card{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      border-radius: var(--radius2);
      padding: 14px;
      margin: 0 0 12px 0;
      overflow:hidden;
    }

    .row{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
    }

    .h{
      margin: 0 0 10px 0;
      font-size: 18px;
      font-weight: 900;
      letter-spacing:.02em;
    }
    .p{
      margin: 0;
      color: var(--muted);
      line-height: 1.45;
      font-weight: 600;
    }
    .small{
      font-size: 12.5px;
      color: var(--muted2);
      line-height: 1.4;
      font-weight: 650;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: var(--chip);
      color: rgba(255,255,255,.86);
      font-weight: 800;
      letter-spacing:.02em;
      cursor:pointer;
      user-select:none;
      transition: background .15s ease;
    }
    .chip:hover{ background: var(--chip2); }

    .kbd{
      font-family: var(--mono);
      font-weight: 800;
      font-size: 12px;
      padding: 4px 6px;
      border-radius: 8px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.88);
    }

    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 820px){ .grid2{ grid-template-columns: 1fr; } }

    .input, select, textarea{
      width:100%;
      background: rgba(255,255,255,.06);
      border:1px solid var(--stroke);
      color: #fff;
      border-radius: 14px;
      padding: 12px 12px;
      outline:none;
      font-weight: 700;
      font-family: var(--ui);
      min-width:0;
    }
    textarea{ min-height: 90px; resize: vertical; }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding: 12px 14px;
      border-radius: 14px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color:#fff;
      font-weight: 900;
      letter-spacing:.02em;
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      white-space: nowrap;
    }
    .btn:hover{ background: rgba(255,255,255,.08); border-color: var(--stroke2); }
    .btn:active{ transform: scale(.99); }
    .btn.primary{
      border-color: rgba(52,211,153,.25);
      background: rgba(52,211,153,.12);
    }
    .btn.primary:hover{ background: rgba(52,211,153,.16); }
    .btn.warn{
      border-color: rgba(251,191,36,.25);
      background: rgba(251,191,36,.10);
    }
    .btn.danger{
      border-color: rgba(251,113,133,.25);
      background: rgba(251,113,133,.10);
    }

    .hr{
      height:1px; background: var(--stroke); margin: 12px 0;
    }

    .list{ display:flex; flex-direction:column; gap:10px; }
    .item{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      border-radius: 16px;
      padding: 12px;
    }
    .itemTop{
      display:flex; gap:10px; justify-content:space-between; align-items:flex-start; flex-wrap:wrap;
    }
    .itemTitle{
      margin:0;
      font-size: 15px;
      font-weight: 950;
      letter-spacing:.02em;
    }
    .itemMeta{
      margin:6px 0 0 0;
      color: var(--muted2);
      font-weight: 750;
      font-size: 12.5px;
      line-height: 1.35;
      font-family: var(--mono);
    }

    details{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.14);
      border-radius: 16px;
      padding: 10px 12px;
    }
    details summary{
      cursor:pointer;
      font-weight: 900;
      letter-spacing:.02em;
      color: rgba(255,255,255,.92);
      list-style: none;
      display:flex; align-items:center; justify-content:space-between;
    }
    details summary::-webkit-details-marker{ display:none; }
    details summary .mut{ color: var(--muted2); font-weight: 800; font-size: 12.5px; }

    .footerBar{
      padding: 10px var(--pad) calc(10px + env(safe-area-inset-bottom)) var(--pad);
      border-top:1px solid var(--stroke);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      color: rgba(255,255,255,.74);
      background: rgba(0,0,0,.18);
      font-weight: 800;
      letter-spacing:.02em;
      flex-wrap:wrap;
    }
    .statusLeft{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .statusDot{
      width:8px;height:8px;border-radius:999px;
      background: var(--green);
      box-shadow: 0 0 14px rgba(52,211,153,.26);
    }
    .mono{ font-family: var(--mono); }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.68);
      border:1px solid rgba(255,255,255,.14);
      color:#fff;
      padding: 10px 12px;
      border-radius: 14px;
      box-shadow: 0 24px 60px rgba(0,0,0,.55);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 9999;
      max-width: min(880px, 94vw);
      font-weight: 800;
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(-2px);
    }

    .tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      font-weight: 900;
      color: rgba(255,255,255,.86);
      font-size: 12.5px;
      letter-spacing:.02em;
    }
    .tag.green{ border-color: rgba(52,211,153,.25); background: rgba(52,211,153,.10); }
    .tag.blue{ border-color: rgba(96,165,250,.25); background: rgba(96,165,250,.10); }
    .tag.amber{ border-color: rgba(251,191,36,.25); background: rgba(251,191,36,.10); }
    .tag.red{ border-color: rgba(251,113,133,.25); background: rgba(251,113,133,.10); }

    .kbdHint{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  </style>
</head>

<body>
  <div class="bg">
    <canvas id="stars"></canvas>
    <div class="earthGlow"></div>
    <div class="horizon"></div>
  </div>

  <div class="app">
    <div class="sheet" id="sheet">
      <div class="handle"></div>

      <div class="sheetTop">
        <div class="titleWrap">
          <h1 class="title">MAP E.D.E.N.</h1>
          <p class="subtitle">
            Earth Diametric Energy Network <span class="dot">•</span>
            <span id="tapHint">Tap Station…</span>
          </p>
        </div>

        <div class="rightControls">
          <div class="modeToggle" aria-label="Mode toggle">
            <button class="modeBtn active" data-mode="lite" title="Lite Mode (read/observe)">Lite</button>
            <button class="modeBtn" data-mode="field" title="Field Mode (capture/post)">Field</button>
            <button class="modeBtn" data-mode="lab" title="Lab Mode (analysis/export)">Lab</button>
          </div>
          <div class="pillX" id="closeBtn" title="Close (demo)">×</div>
        </div>
      </div>

      <div class="navGrid" id="navGrid">
        <button class="navBtn active" data-panel="hello"><span class="lamp"></span>Hello</button>
        <button class="navBtn" data-panel="mission"><span class="lamp"></span>Mission</button>

        <button class="navBtn" data-panel="core"><span class="lamp"></span>Core</button>
        <button class="navBtn" data-panel="stack"><span class="lamp"></span>Stack</button>

        <button class="navBtn" data-panel="stations"><span class="lamp"></span>Stations</button>
        <button class="navBtn" data-panel="overlay"><span class="lamp"></span>Overlay +</button>

        <button class="navBtn danger" data-panel="clear"><span class="lamp"></span>Clear</button>
        <button class="navBtn" data-panel="profile"><span class="lamp"></span>Profile</button>
      </div>

      <div class="content" id="content">

        <!-- HELLO -->
        <section class="panel active" id="panel-hello">
          <div class="card">
            <div class="row" style="justify-content:space-between;">
              <div>
                <h2 class="h">Welcome</h2>
                <p class="p">A minimal, high-trust field network for repeatable Earth research.</p>
                <p class="small" style="margin-top:10px;">
                  This <span class="kbd">index.html</span> is a futuristic UI prototype: profiles, stations, overlays, stacks, assets, permissions, and exports.
                  All data is stored locally in your browser (localStorage) until you connect a backend.
                </p>
              </div>
              <div class="kbdHint">
                <span class="tag green">User-friendly</span>
                <span class="tag blue">Minimal</span>
                <span class="tag amber">Field + Lab</span>
                <span class="tag red">100% Control</span>
              </div>
            </div>
          </div>

          <div class="grid2">
            <div class="card">
              <h2 class="h">Quick Start</h2>
              <p class="p">Create a Station → enable an Overlay Stack → run a Session → export.</p>
              <div class="hr"></div>
              <div class="row">
                <button class="btn primary" id="goStations">Create Station</button>
                <button class="btn" id="goOverlay">Enable Overlays</button>
                <button class="btn" id="goProfile">Share Assets</button>
              </div>
            </div>

            <div class="card">
              <h2 class="h">Network Principles</h2>
              <p class="p">Progressive disclosure: simple defaults, advanced power on demand.</p>
              <p class="small" style="margin-top:10px;">
                Privacy-first: every object (post, station, file, overlay, session) has permissions:
                <span class="kbd">Public</span> / <span class="kbd">Network</span> / <span class="kbd">Group</span> / <span class="kbd">Direct</span> / <span class="kbd">Only Me</span>.
              </p>
            </div>
          </div>
        </section>

        <!-- MISSION -->
        <section class="panel" id="panel-mission">
          <div class="card">
            <h2 class="h">MISSION</h2>
            <p class="p">
              MAP E.D.E.N. is the operational field platform for Project E.D.E.N. (Earth Diametric &amp; Energy Network) —
              a secure, repeatable way to run real-world tests along defined Earth corridors, beginning with the 42/222
              diametric axis (42° and 222° are opposite bearings on the same straight line).
            </p>
            <p class="p" style="margin-top:10px;">
              MAP E.D.E.N. equips trusted members with clear protocols to collect environmental field measurements and navigation-behavior observations,
              so results can be compared across stations, time, and methods — with strong privacy and member-controlled data.
            </p>
          </div>

          <div class="card">
            <h2 class="h">What makes it better than X / Threads / Discord</h2>
            <div class="list">
              <div class="item">
                <p class="itemTitle">Research Thread (micro-post + expandable evidence)</p>
                <p class="small">Looks like a short post — expands into protocol, station metadata, evidence bundle, replication, and baseline comparison.</p>
              </div>
              <div class="item">
                <p class="itemTitle">Signed provenance + permissions on everything</p>
                <p class="small">Integrity without forcing identity. Verification is opt-in, privacy-safe, and role-based.</p>
              </div>
              <div class="item">
                <p class="itemTitle">Overlay engine (the moat)</p>
                <p class="small">Earth research overlays, overlay stacks, provenance, and on-device rendering.</p>
              </div>
              <div class="item">
                <p class="itemTitle">Stations as real lab nodes</p>
                <p class="small">Precision modes, accuracy metadata, session runner, UTC tagging, and exports.</p>
              </div>
            </div>
          </div>
        </section>

        <!-- CORE -->
        <section class="panel" id="panel-core">
          <div class="card">
            <h2 class="h">Core</h2>
            <p class="p">Minimal controls for a socially-intelligent, high-trust network.</p>
            <div class="hr"></div>

            <div class="grid2">
              <div class="item">
                <p class="itemTitle">Network Safety</p>
                <p class="small">
                  • Role-based access • Signed objects • Optional verification tiers • Local-first storage in this prototype.
                </p>
              </div>
              <div class="item">
                <p class="itemTitle">Data Control</p>
                <p class="small">
                  • Export anytime • Delete anytime • Access logs • Granular permissions • Optional opt-in data donation.
                </p>
              </div>
            </div>

            <div class="hr"></div>

            <div class="row">
              <span class="tag green">Running</span>
              <span class="tag blue">On-device UI</span>
              <span class="tag amber">Provenance-ready</span>
              <span class="tag red">Privacy-by-default</span>
            </div>
          </div>

          <div class="card">
            <h2 class="h">Research Thread (prototype)</h2>
            <div class="grid2">
              <div>
                <input class="input" id="postText" placeholder="Write a short research thread..." />
                <div class="row" style="margin-top:10px;">
                  <select id="postPermission">
                    <option value="onlyme">Only Me</option>
                    <option value="direct">Direct</option>
                    <option value="group">Group</option>
                    <option value="network">Network</option>
                    <option value="public">Public</option>
                  </select>
                  <select id="postStation"></select>
                </div>
                <div class="row" style="margin-top:10px;">
                  <button class="btn primary" id="addPost">Post</button>
                  <button class="btn" id="attachBundle">Attach Evidence Bundle (demo)</button>
                </div>
                <p class="small" style="margin-top:10px;">
                  In a real build, bundles include session exports, media, and signed metadata. Here it’s a simulated attachment.
                </p>
              </div>

              <div>
                <div class="item">
                  <p class="itemTitle">Social intelligence (non-spam)</p>
                  <p class="small">
                    • Compare-to-baseline prompt • Replication prompts • Signal hygiene hints • “What changed?” summaries (on-device/private compute).
                  </p>
                </div>
                <div class="item" style="margin-top:10px;">
                  <p class="itemTitle">Integrity without doxxing</p>
                  <p class="small">
                    • Optional verification tiers • Station Verified • Research Verified (peer endorsements).
                  </p>
                </div>
              </div>
            </div>

            <div class="hr"></div>
            <div class="list" id="postsList"></div>
          </div>
        </section>

        <!-- STACK -->
        <section class="panel" id="panel-stack">
          <div class="card">
            <h2 class="h">Overlay Stacks</h2>
            <p class="p">Stacks are saved presets (minimal UI): enable a few overlays, keep the network clean.</p>
            <div class="hr"></div>

            <div class="grid2">
              <div>
                <label class="small">Active Stack</label>
                <select id="activeStack"></select>
                <div class="row" style="margin-top:10px;">
                  <input class="input" id="newStackName" placeholder="New stack name (e.g., Quiet Magnetics)" />
                  <button class="btn primary" id="createStack">Create</button>
                </div>
                <p class="small" style="margin-top:10px;">
                  Each overlay in a stack carries provenance: source, version, update time, confidence.
                </p>
              </div>

              <div>
                <div class="item">
                  <p class="itemTitle">Stack permissions</p>
                  <p class="small">
                    Stacks can be: private, group-only, station-only, or public.
                    (This prototype stores permissions locally; your backend will enforce.)
                  </p>
                </div>
                <div class="row" style="margin-top:10px;">
                  <select id="stackPermission">
                    <option value="onlyme">Only Me</option>
                    <option value="station">Station Only</option>
                    <option value="group">Group</option>
                    <option value="network">Network</option>
                    <option value="public">Public</option>
                  </select>
                  <button class="btn" id="saveStackPermission">Save</button>
                  <button class="btn danger" id="deleteStack">Delete Stack</button>
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <h2 class="h">Active Overlays (in stack)</h2>
            <div class="list" id="activeOverlaysList"></div>
          </div>
        </section>

        <!-- STATIONS -->
        <section class="panel" id="panel-stations">
          <div class="card">
            <h2 class="h">Stations</h2>
            <p class="p">Stations are lab nodes: precise location modes, accuracy metadata, session runner, exports.</p>
            <div class="hr"></div>

            <div class="grid2">
              <div>
                <label class="small">Create Station</label>
                <input class="input" id="stationName" placeholder="Station name (e.g., Station 1 • Staunton)" />
                <div class="row" style="margin-top:10px;">
                  <select id="stationPrecision">
                    <option value="public">Public (Approx)</option>
                    <option value="group">Group (Medium)</option>
                    <option value="private">Private (Exact)</option>
                  </select>
                  <button class="btn primary" id="captureGeo">Capture Coordinates</button>
                </div>

                <div class="item" style="margin-top:10px;">
                  <p class="itemTitle">Captured Coordinates</p>
                  <p class="itemMeta" id="geoPreview">No coordinates yet.</p>
                </div>

                <div class="row" style="margin-top:10px;">
                  <button class="btn primary" id="createStationBtn">+ Create</button>
                  <button class="btn" id="addTestSpot">+ Test Spot</button>
                </div>

                <p class="small" style="margin-top:10px;">
                  Tip: Geolocation requires HTTPS. GitHub Pages is perfect.
                  For RTK/external GNSS later: add “Receiver Profiles” in Lab mode.
                </p>
              </div>

              <div>
                <div class="item">
                  <p class="itemTitle">Station capabilities (advanced)</p>
                  <p class="small">
                    • Origin pin + test spots • Horizontal/vertical accuracy • UTC tagging • Calibration status • Loadout inventory • Replication beacon
                  </p>
                </div>
                <div class="item" style="margin-top:10px;">
                  <p class="itemTitle">Privacy controls</p>
                  <p class="small">
                    Coordinate precision per audience: Public / Group / Private.
                    You can share “within 1–5km” publicly while keeping exact private.
                  </p>
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <h2 class="h">Station List</h2>
            <div class="list" id="stationsList"></div>
          </div>

          <div class="card">
            <h2 class="h">Session Runner</h2>
            <div class="grid2">
              <div>
                <label class="small">Station</label>
                <select id="sessionStation"></select>

                <label class="small" style="display:block;margin-top:10px;">Protocol</label>
                <select id="sessionProtocol">
                  <option value="EDEN-PT-MAG-01">EDEN-PT-MAG-01 • Phone Magnetometer (Noise-Controlled)</option>
                  <option value="EDEN-RF-01">EDEN-RF-01 • RF Quiet Scan (Controlled)</option>
                  <option value="EDEN-AXIS-42-222">EDEN-AXIS-42/222 • Corridor Run (Field)</option>
                  <option value="EDEN-OBS-01">EDEN-OBS-01 • Observation Log (Behavior/Navigation)</option>
                </select>

                <label class="small" style="display:block;margin-top:10px;">Notes</label>
                <textarea id="sessionNotes" placeholder="Session notes (conditions, controls, anomalies, equipment)..."></textarea>

                <div class="row" style="margin-top:10px;">
                  <select id="sessionPermission">
                    <option value="onlyme">Only Me</option>
                    <option value="station">Station Only</option>
                    <option value="group">Group</option>
                    <option value="network">Network</option>
                    <option value="public">Public</option>
                  </select>
                  <button class="btn primary" id="startSession">Start Session</button>
                  <button class="btn" id="exportStation">Export Station Data</button>
                </div>

                <p class="small" style="margin-top:10px;">
                  This prototype generates a signed-like session record with UTC timestamp + accuracy metadata if available.
                </p>
              </div>

              <div>
                <div class="item">
                  <p class="itemTitle">Session integrity (future backend)</p>
                  <p class="small">
                    • Cryptographic signatures • Immutable provenance • Device/sensor fingerprints • Optional external sensor pairing
                  </p>
                </div>
                <div class="item" style="margin-top:10px;">
                  <p class="itemTitle">Replication prompts</p>
                  <p class="small">
                    • “Run this protocol nearby today” • “Compare last 10 runs vs baseline” • “Check interference map” (all opt-in)
                  </p>
                </div>
              </div>
            </div>

            <div class="hr"></div>
            <div class="list" id="sessionsList"></div>
          </div>
        </section>

        <!-- OVERLAY -->
        <section class="panel" id="panel-overlay">
          <div class="card">
            <h2 class="h">Overlay + (Max Library)</h2>
            <p class="p">Enable overlays for Earth research & experimentation. Keep UI minimal by stacking only what you need.</p>
            <div class="hr"></div>

            <div class="grid2">
              <div>
                <input class="input" id="overlaySearch" placeholder="Search overlays (e.g., geomagnetic, ionosphere, migration, tectonic)..." />
                <div class="row" style="margin-top:10px;">
                  <select id="overlayPermissionDefault">
                    <option value="onlyme">Default: Only Me</option>
                    <option value="group">Default: Group</option>
                    <option value="network">Default: Network</option>
                    <option value="public">Default: Public</option>
                  </select>
                  <button class="btn" id="applyOverlayDefault">Apply</button>
                  <button class="btn primary" id="addOverlayPack">+ Publish Overlay Pack (demo)</button>
                </div>

                <p class="small" style="margin-top:10px;">
                  Each overlay shows provenance: <span class="kbd">source</span> / <span class="kbd">version</span> / <span class="kbd">updated</span> / <span class="kbd">confidence</span>.
                </p>
              </div>

              <div>
                <div class="item">
                  <p class="itemTitle">Overlay engine features</p>
                  <p class="small">
                    • Overlay Stacks • Provenance • Member overlay packs • On-device rendering • Permissioned overlays • Minimal enabled set
                  </p>
                </div>
                <div class="item" style="margin-top:10px;">
                  <p class="itemTitle">Your unique moat</p>
                  <p class="small">
                    Axis overlays (42/222), replication maps, station quality heatmaps, and event clustering.
                  </p>
                </div>
              </div>
            </div>
          </div>

          <div id="overlayLibrary"></div>
        </section>

        <!-- PROFILE -->
        <section class="panel" id="panel-profile">
          <div class="card">
            <div class="row" style="justify-content:space-between;">
              <div>
                <h2 class="h">Member Profile</h2>
                <p class="p">Research passport + secure media vault + social graph — minimal, powerful, private.</p>
              </div>
              <div class="row">
                <span class="tag green" id="verifTag">Basic Verified</span>
                <span class="tag blue" id="roleTag">Operator</span>
              </div>
            </div>

            <div class="hr"></div>

            <div class="grid2">
              <div>
                <label class="small">Display Name</label>
                <input class="input" id="memberName" placeholder="Member" />

                <div class="row" style="margin-top:10px;">
                  <select id="memberRole">
                    <option value="Owner">Owner</option>
                    <option value="Operator" selected>Operator</option>
                    <option value="Observer">Observer</option>
                    <option value="Analyst">Analyst</option>
                  </select>
                  <select id="memberVerification">
                    <option value="Basic Verified" selected>Basic Verified</option>
                    <option value="Station Verified">Station Verified</option>
                    <option value="Research Verified">Research Verified</option>
                  </select>
                  <button class="btn primary" id="saveProfile">Save</button>
                </div>

                <div class="item" style="margin-top:10px;">
                  <p class="itemTitle">Keys &amp; Control (prototype)</p>
                  <p class="small">
                    • Device key vault (future) • E2E encryption toggle • Access logs • Export/delete controls.
                  </p>
                  <div class="row" style="margin-top:10px;">
                    <span class="chip" id="toggleE2E">E2E: ON</span>
                    <span class="chip" id="toggleAudit">Audit Log: ON</span>
                    <span class="chip" id="toggleDonation">Data Donation: OFF</span>
                  </div>
                </div>
              </div>

              <div>
                <div class="item">
                  <p class="itemTitle">Network tools (better than microblogging)</p>
                  <p class="small">
                    • Research Threads • Groups/Ops • DMs (future E2E) • Shared Stacks • Shared Protocols • Collections
                  </p>
                </div>
                <div class="item" style="margin-top:10px;">
                  <p class="itemTitle">Provenance</p>
                  <p class="small">
                    All posts/files/sessions can be “signed” (future cryptography). This prototype marks items with a local signature stub.
                  </p>
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <h2 class="h">Assets (Files • Photos • Video • Audio • Bundles)</h2>
            <div class="grid2">
              <div>
                <input class="input" id="assetTitle" placeholder="Asset title (e.g., Station 1 magnetometer export)" />
                <div class="row" style="margin-top:10px;">
                  <select id="assetType">
                    <option value="file">File</option>
                    <option value="photo">Photo</option>
                    <option value="video">Video</option>
                    <option value="audio">Audio</option>
                    <option value="bundle">Evidence Bundle</option>
                  </select>
                  <select id="assetPermission">
                    <option value="onlyme">Only Me</option>
                    <option value="direct">Direct</option>
                    <option value="group">Group</option>
                    <option value="network">Network</option>
                    <option value="public">Public</option>
                  </select>
                </div>
                <div class="row" style="margin-top:10px;">
                  <select id="assetStation"></select>
                  <input class="input" id="assetTags" placeholder="Tags (comma separated)" />
                </div>
                <div class="row" style="margin-top:10px;">
                  <input class="input" type="file" id="assetFile" />
                  <button class="btn primary" id="addAsset">Upload (local demo)</button>
                </div>
                <p class="small" style="margin-top:10px;">
                  In production: encrypted uploads + versioning + provenance timeline + annotations.
                </p>
              </div>

              <div>
                <div class="item">
                  <p class="itemTitle">Versioning + provenance (future)</p>
                  <p class="small">
                    Update an asset without breaking links. Keep “who/when/what” signatures and optional peer verification.
                  </p>
                </div>

                <div class="item" style="margin-top:10px;">
                  <p class="itemTitle">100% control controls</p>
                  <p class="small">
                    One-tap export, revoke access, hard delete, and full access logs per asset.
                  </p>
                  <div class="row" style="margin-top:10px;">
                    <button class="btn" id="exportAll">Export My Archive</button>
                    <button class="btn danger" id="hardDeleteAll">Hard Delete My Data</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="hr"></div>
            <div class="list" id="assetsList"></div>
          </div>

          <div class="card">
            <h2 class="h">Access Log (prototype)</h2>
            <p class="small">Shows local “reads/exports/deletes” events (in real build: cryptographic audit trail).</p>
            <div class="hr"></div>
            <div class="list" id="accessLog"></div>
          </div>
        </section>

        <!-- CLEAR -->
        <section class="panel" id="panel-clear">
          <div class="card">
            <h2 class="h">Clear</h2>
            <p class="p">This wipes the prototype database stored in your browser (localStorage).</p>
            <div class="hr"></div>
            <div class="row">
              <button class="btn danger" id="wipeLocal">Wipe Local Data</button>
              <button class="btn" id="exportBeforeWipe">Export First</button>
            </div>
            <p class="small" style="margin-top:10px;">
              If you’re using GitHub Pages, clearing localStorage does not affect your repo files.
            </p>
          </div>
        </section>

      </div>

      <div class="footerBar">
        <div class="statusLeft">
          <span class="statusDot"></span>
          <span>Running</span>
          <span class="mono">• Texture fallback: stars</span>
          <span class="mono" id="exitLabel">Exit 222</span>
        </div>
        <div class="mono" id="stationFooter">Station 0 @ N/A</div>
      </div>
    </div>

    <div class="toast" id="toast">Saved.</div>
  </div>

  <script>
    /***********************
     * MAP E.D.E.N. — Futuristic Prototype (Single-file index.html)
     * - Local-first storage (localStorage)
     * - Profiles, Stations, Sessions, Overlay Library, Stacks, Assets, Posts
     * - Permissions + provenance UI (backend enforcement later)
     ************************/

    const LS_KEY = "MAP_EDEN_V1_PROTO";

    const nowISO = () => new Date().toISOString();
    const utcShort = () => new Date().toISOString().replace("T"," ").replace("Z"," UTC");
    const uid = (p="id") => p + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);

    const toastEl = document.getElementById("toast");
    const toast = (msg) => {
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(()=>toastEl.classList.remove("show"), 1600);
    };

    const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));

    function loadState(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(raw) return JSON.parse(raw);
      }catch(e){}
      return seedState();
    }

    function saveState(){
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    }

    function logAccess(type, target, detail=""){
      if(!state.profile.auditLog) return;
      state.accessLog.unshift({
        id: uid("log"),
        ts: nowISO(),
        type, target, detail
      });
      state.accessLog = state.accessLog.slice(0, 60);
      saveState();
      renderAccessLog();
    }

    function seedOverlayLibrary(){
      // “Max library” structure (expand as you wish).
      const lib = [
        {
          category: "Planetary Physics & Geophysics",
          items: [
            mkOverlay("geomag_intensity", "Geomagnetic Intensity", "Field magnitude layer (measurement context).", "EDEN / NOAA-like", "1.0", "medium"),
            mkOverlay("geomag_declination", "Magnetic Declination", "Declination reference for navigation context.", "EDEN / WMM-like", "1.0", "medium"),
            mkOverlay("geomag_anomalies", "Magnetic Anomalies", "Anomaly regions (interpretive context).", "EDEN / public datasets", "1.0", "low"),
            mkOverlay("tectonic_plates", "Tectonic Plates", "Plate boundaries & rifts for geophysical context.", "USGS-like", "1.0", "high"),
            mkOverlay("seismic_events", "Seismic Events", "Earthquake events stream (optional).", "USGS-like", "1.0", "high"),
            mkOverlay("gravity_elevation", "Elevation / Terrain", "Contours, slope, ridge lines, horizon profile.", "EDEN / DEM", "1.0", "high"),
          ]
        },
        {
          category: "Atmosphere • Ocean • Cryosphere",
          items: [
            mkOverlay("weather_readiness", "Field Weather Readiness", "Wind/precip/temp snapshot for field planning.", "EDEN / weather", "1.0", "high"),
            mkOverlay("pressure_systems", "Pressure Systems", "Pressure gradients & fronts (optional).", "EDEN / met", "1.0", "medium"),
            mkOverlay("lightning_density", "Lightning Density", "Storm noise + research context overlay.", "EDEN / lightning", "1.0", "medium"),
            mkOverlay("ocean_currents", "Ocean Currents", "Major gyres/currents for timing correlations.", "EDEN / ocean", "1.0", "medium"),
            mkOverlay("tides_moon", "Tides + Moon Phase", "Tidal context and lunar phase timing.", "EDEN / astro", "1.0", "high"),
          ]
        },
        {
          category: "Space Weather & Astronomy Context",
          items: [
            mkOverlay("auroral_oval", "Auroral Oval Probability", "Aurora likelihood context (optional).", "EDEN / space weather", "1.0", "medium"),
            mkOverlay("solar_disturbance", "Solar Disturbance Risk", "Kp-like disturbance risk indicator (context).", "EDEN / space weather", "1.0", "medium"),
            mkOverlay("light_pollution", "Light Pollution", "Night sky quality for optical runs.", "EDEN / public", "1.0", "high"),
            mkOverlay("terminator_line", "Sunrise Terminator Line", "Day/night boundary timing overlay.", "EDEN / astro", "1.0", "high"),
          ]
        },
        {
          category: "Biology & Navigation",
          items: [
            mkOverlay("migration_corridors", "Migration Corridors", "Seasonal migration corridors (optional).", "EDEN / ecology", "1.0", "low"),
            mkOverlay("magnetoreception_prompt", "Magnetoreception Study Prompts", "Protocol reminders & control prompts.", "EDEN", "1.0", "high"),
          ]
        },
        {
          category: "Human Infrastructure & Noise",
          items: [
            mkOverlay("rf_quiet_zones", "RF Quiet Zones", "Where-to-measure overlay (privacy safe).", "EDEN / member-measured", "1.0", "low"),
            mkOverlay("grid_proximity", "Grid Proximity", "Infrastructure proximity context (optional).", "EDEN / public", "1.0", "low"),
            mkOverlay("urban_interference", "Urban Interference Likelihood", "Derived from station stats (privacy-safe).", "EDEN / network", "1.0", "medium"),
          ]
        },
        {
          category: "E.D.E.N. Network Overlays (Moat)",
          items: [
            mkOverlay("axis_42_222", "42/222 Axis Suite", "Rhumb/Geodesic/True line + corridor offsets.", "EDEN", "1.0", "high"),
            mkOverlay("station_quality", "Station Quality Heatmap", "Quality-weighted station readiness map.", "EDEN / network", "1.0", "medium"),
            mkOverlay("event_clusters", "Event Clusters", "Time-window clustering along corridors.", "EDEN / network", "1.0", "medium"),
            mkOverlay("replication_map", "Replication Map", "Who ran the same protocol nearby/time-window.", "EDEN / network", "1.0", "high"),
          ]
        }
      ];
      return lib;
    }

    function mkOverlay(id, name, desc, source, version, confidence){
      return { id, name, desc, source, version, updated: nowISO().slice(0,10), confidence };
    }

    function seedState(){
      const base = {
        app: { mode: "lite", activePanel: "hello" },
        profile: {
          name: "Member",
          role: "Operator",
          verification: "Basic Verified",
          e2e: true,
          auditLog: true,
          dataDonation: false
        },
        stacks: [
          { id: uid("stack"), name: "Default Stack", permission: "onlyme", overlays: [] }
        ],
        activeStackId: null,
        overlayLibrary: seedOverlayLibrary(),
        overlayDefaultPermission: "onlyme",
        stations: [],
        sessions: [],
        assets: [],
        posts: [],
        accessLog: []
      };
      base.activeStackId = base.stacks[0].id;
      return base;
    }

    let state = loadState();

    /***********************
     * STARFIELD (lightweight)
     ************************/
    const canvas = document.getElementById("stars");
    const ctx = canvas.getContext("2d", { alpha:true });
    let W=0,H=0,stars=[];
    function resizeStars(){
      W = canvas.width = Math.floor(window.innerWidth * devicePixelRatio);
      H = canvas.height = Math.floor(window.innerHeight * devicePixelRatio);
      canvas.style.width = window.innerWidth + "px";
      canvas.style.height = window.innerHeight + "px";
      stars = Array.from({length: clamp(Math.floor((W*H)/70000), 90, 240)}, ()=>({
        x: Math.random()*W,
        y: Math.random()*H,
        r: (Math.random()*1.6+0.4)*devicePixelRatio,
        a: Math.random()*0.55+0.25
      }));
      drawStars();
    }
    function drawStars(){
      ctx.clearRect(0,0,W,H);
      for(const s of stars){
        ctx.beginPath();
        ctx.fillStyle = `rgba(255,255,255,${s.a})`;
        ctx.arc(s.x,s.y,s.r,0,Math.PI*2);
        ctx.fill();
      }
    }
    window.addEventListener("resize", resizeStars);
    resizeStars();

    /***********************
     * NAV + MODE
     ************************/
    const navButtons = Array.from(document.querySelectorAll(".navBtn"));
    const panels = {
      hello: document.getElementById("panel-hello"),
      mission: document.getElementById("panel-mission"),
      core: document.getElementById("panel-core"),
      stack: document.getElementById("panel-stack"),
      stations: document.getElementById("panel-stations"),
      overlay: document.getElementById("panel-overlay"),
      profile: document.getElementById("panel-profile"),
      clear: document.getElementById("panel-clear"),
    };

    function setActivePanel(key){
      state.app.activePanel = key;
      for(const b of navButtons){
        const on = b.dataset.panel === key;
        b.classList.toggle("active", on);
      }
      for(const k in panels){
        panels[k].classList.toggle("active", k===key);
      }
      saveState();
      toast(`${key.toUpperCase()} ready`);
      if(key === "core") renderCore();
      if(key === "stack") renderStacks();
      if(key === "overlay") renderOverlayLibrary();
      if(key === "stations") renderStations();
      if(key === "profile") renderProfile();
      if(key === "clear") {/* no-op */}
      syncFooter();
    }

    navButtons.forEach(btn=>{
      btn.addEventListener("click", ()=> setActivePanel(btn.dataset.panel));
    });

    const modeBtns = Array.from(document.querySelectorAll(".modeBtn"));
    function setMode(mode){
      state.app.mode = mode;
      modeBtns.forEach(b=>b.classList.toggle("active", b.dataset.mode===mode));
      saveState();
      toast(`Mode: ${mode.toUpperCase()}`);
      // In a real app, this would progressively disclose UI. Here it just changes hint text.
      const tapHint = document.getElementById("tapHint");
      if(mode==="lite") tapHint.textContent = "Tap Station…";
      if(mode==="field") tapHint.textContent = "Capture → Post → Replicate…";
      if(mode==="lab") tapHint.textContent = "Analyze → Export → Compare…";
    }
    modeBtns.forEach(b=>b.addEventListener("click", ()=> setMode(b.dataset.mode)));

    document.getElementById("closeBtn").addEventListener("click", ()=>{
      toast("Close (demo) — sheet stays open in prototype.");
    });

    /***********************
     * HELLO quick nav
     ************************/
    document.getElementById("goStations").addEventListener("click", ()=> setActivePanel("stations"));
    document.getElementById("goOverlay").addEventListener("click", ()=> setActivePanel("overlay"));
    document.getElementById("goProfile").addEventListener("click", ()=> setActivePanel("profile"));

    /***********************
     * STACKS
     ************************/
    const activeStackSel = document.getElementById("activeStack");
    const newStackName = document.getElementById("newStackName");
    const stackPermSel = document.getElementById("stackPermission");

    document.getElementById("createStack").addEventListener("click", ()=>{
      const name = (newStackName.value || "").trim();
      if(!name){ toast("Name your stack."); return; }
      const s = { id: uid("stack"), name, permission: "onlyme", overlays: [] };
      state.stacks.unshift(s);
      state.activeStackId = s.id;
      newStackName.value = "";
      saveState();
      renderStacks();
      toast("Stack created.");
      logAccess("write", "stack", `create:${name}`);
    });

    document.getElementById("deleteStack").addEventListener("click", ()=>{
      if(state.stacks.length<=1){ toast("Keep at least 1 stack."); return; }
      const id = state.activeStackId;
      const cur = state.stacks.find(s=>s.id===id);
      state.stacks = state.stacks.filter(s=>s.id!==id);
      state.activeStackId = state.stacks[0].id;
      saveState();
      renderStacks();
      toast("Stack deleted.");
      logAccess("delete", "stack", `delete:${cur?.name||id}`);
    });

    document.getElementById("saveStackPermission").addEventListener("click", ()=>{
      const s = getActiveStack();
      if(!s) return;
      s.permission = stackPermSel.value;
      saveState();
      renderStacks();
      toast("Stack permission saved.");
      logAccess("write", "stack", `perm:${s.name}=${s.permission}`);
    });

    function getActiveStack(){
      return state.stacks.find(s=>s.id===state.activeStackId);
    }

    function renderStacks(){
      activeStackSel.innerHTML = "";
      for(const s of state.stacks){
        const opt = document.createElement("option");
        opt.value = s.id;
        opt.textContent = `${s.name}`;
        activeStackSel.appendChild(opt);
      }
      activeStackSel.value = state.activeStackId;

      const s = getActiveStack();
      stackPermSel.value = s?.permission || "onlyme";

      renderActiveOverlays();
    }

    activeStackSel.addEventListener("change", ()=>{
      state.activeStackId = activeStackSel.value;
      saveState();
      renderStacks();
      toast("Active stack changed.");
    });

    function renderActiveOverlays(){
      const list = document.getElementById("activeOverlaysList");
      list.innerHTML = "";
      const s = getActiveStack();
      const overlays = s?.overlays || [];
      if(overlays.length===0){
        list.innerHTML = `<div class="item"><p class="itemTitle">No overlays enabled.</p><p class="small">Go to Overlay+ and add overlays into this stack.</p></div>`;
        return;
      }
      overlays.forEach(o=>{
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="itemTop">
            <div>
              <p class="itemTitle">${escapeHTML(o.name)}</p>
              <p class="small">${escapeHTML(o.desc)}</p>
              <p class="itemMeta">source=${escapeHTML(o.source)} • v=${escapeHTML(o.version)} • updated=${escapeHTML(o.updated)} • confidence=${escapeHTML(o.confidence)}</p>
            </div>
            <div class="row">
              <select data-ovperm="${o.id}">
                <option value="onlyme">Only Me</option>
                <option value="group">Group</option>
                <option value="network">Network</option>
                <option value="public">Public</option>
              </select>
              <button class="btn danger" data-ovdel="${o.id}">Remove</button>
            </div>
          </div>
        `;
        list.appendChild(el);

        const sel = el.querySelector(`select[data-ovperm="${o.id}"]`);
        sel.value = o.permission || "onlyme";
        sel.addEventListener("change", ()=>{
          o.permission = sel.value;
          saveState();
          toast("Overlay permission updated.");
          logAccess("write", "overlay", `perm:${o.name}=${o.permission}`);
        });

        el.querySelector(`button[data-ovdel="${o.id}"]`).addEventListener("click", ()=>{
          const s = getActiveStack();
          s.overlays = s.overlays.filter(x=>x.id!==o.id);
          saveState();
          renderActiveOverlays();
          toast("Overlay removed.");
          logAccess("delete", "overlay", `remove:${o.name}`);
        });
      });
    }

    /***********************
     * OVERLAYS
     ************************/
    const overlaySearch = document.getElementById("overlaySearch");
    const overlayDefaultPermission = document.getElementById("overlayPermissionDefault");
    const applyOverlayDefault = document.getElementById("applyOverlayDefault");

    overlayDefaultPermission.value = state.overlayDefaultPermission || "onlyme";

    applyOverlayDefault.addEventListener("click", ()=>{
      state.overlayDefaultPermission = overlayDefaultPermission.value;
      saveState();
      toast("Overlay default applied.");
      logAccess("write", "overlay", `defaultPerm=${state.overlayDefaultPermission}`);
      renderOverlayLibrary();
    });

    document.getElementById("addOverlayPack").addEventListener("click", ()=>{
      toast("Published Overlay Pack (demo). In production: signed overlay packs with provenance.");
      logAccess("write", "overlaypack", "publish:demo");
    });

    overlaySearch.addEventListener("input", renderOverlayLibrary);

    function renderOverlayLibrary(){
      const root = document.getElementById("overlayLibrary");
      root.innerHTML = "";
      const q = (overlaySearch.value || "").trim().toLowerCase();

      state.overlayLibrary.forEach(cat=>{
        const filtered = cat.items.filter(o=>{
          if(!q) return true;
          return (o.name + " " + o.desc + " " + o.source).toLowerCase().includes(q);
        });

        const det = document.createElement("details");
        det.open = !!q; // open when searching
        det.innerHTML = `
          <summary>
            <span>${escapeHTML(cat.category)}</span>
            <span class="mut">${filtered.length}/${cat.items.length}</span>
          </summary>
          <div style="margin-top:10px;" class="list"></div>
        `;
        const list = det.querySelector(".list");

        filtered.forEach(o=>{
          const enabled = isOverlayEnabled(o.id);
          const el = document.createElement("div");
          el.className = "item";
          el.innerHTML = `
            <div class="itemTop">
              <div>
                <p class="itemTitle">${escapeHTML(o.name)}</p>
                <p class="small">${escapeHTML(o.desc)}</p>
                <p class="itemMeta">source=${escapeHTML(o.source)} • v=${escapeHTML(o.version)} • updated=${escapeHTML(o.updated)} • confidence=${escapeHTML(o.confidence)}</p>
              </div>
              <div class="row">
                <select data-addperm="${o.id}">
                  <option value="onlyme">Only Me</option>
                  <option value="group">Group</option>
                  <option value="network">Network</option>
                  <option value="public">Public</option>
                </select>
                <button class="btn ${enabled ? "danger" : "primary"}" data-toggleov="${o.id}">
                  ${enabled ? "Disable" : "Enable"}
                </button>
              </div>
            </div>
          `;

          const sel = el.querySelector(`select[data-addperm="${o.id}"]`);
          sel.value = state.overlayDefaultPermission || "onlyme";

          el.querySelector(`button[data-toggleov="${o.id}"]`).addEventListener("click", ()=>{
            const s = getActiveStack();
            if(!s){ toast("Create a stack first."); return; }

            if(isOverlayEnabled(o.id)){
              s.overlays = s.overlays.filter(x=>x.id!==o.id);
              toast("Overlay disabled.");
              logAccess("delete", "overlay", `disable:${o.name}`);
            }else{
              s.overlays.unshift({ ...o, permission: sel.value });
              toast("Overlay enabled.");
              logAccess("write", "overlay", `enable:${o.name} perm=${sel.value}`);
            }
            saveState();
            renderOverlayLibrary();
            renderActiveOverlays();
          });

          list.appendChild(el);
        });

        root.appendChild(det);
      });
    }

    function isOverlayEnabled(overlayId){
      const s = getActiveStack();
      return !!s?.overlays?.some(o=>o.id===overlayId);
    }

    /***********************
     * STATIONS (Geo + list + sessions)
     ************************/
    const geoPreview = document.getElementById("geoPreview");
    let lastGeo = null;

    function formatDMS(deg, isLat){
      const dir = isLat ? (deg>=0 ? "N":"S") : (deg>=0 ? "E":"W");
      const a = Math.abs(deg);
      const d = Math.floor(a);
      const mFloat = (a - d) * 60;
      const m = Math.floor(mFloat);
      const s = (mFloat - m) * 60;
      return `${d}°${m}'${s.toFixed(3)}"${dir}`;
    }

    function setGeoPreview(pos){
      const { latitude, longitude, accuracy, altitude, altitudeAccuracy } = pos.coords;
      const ts = new Date(pos.timestamp).toISOString();
      lastGeo = {
        lat: latitude,
        lon: longitude,
        accuracy: accuracy ?? null,
        alt: altitude ?? null,
        altAccuracy: altitudeAccuracy ?? null,
        ts
      };
      geoPreview.textContent =
        `lat=${latitude.toFixed(8)} • lon=${longitude.toFixed(8)} • hAcc=±${Math.round(accuracy||0)}m` +
        (altitude!=null ? ` • alt=${altitude.toFixed(2)}m` : ``) +
        (altitudeAccuracy!=null ? ` • vAcc=±${Math.round(altitudeAccuracy)}m` : ``) +
        ` • ${ts}`;
      syncFooter();
    }

    document.getElementById("captureGeo").addEventListener("click", ()=>{
      toast("Capturing coordinates…");
      if(!navigator.geolocation){
        toast("Geolocation not available on this device/browser.");
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos)=>{ setGeoPreview(pos); toast("Coordinates captured."); logAccess("read", "geolocation", "capture"); },
        (err)=>{ toast("Geo error: " + err.message); },
        { enableHighAccuracy:true, timeout:12000, maximumAge:0 }
      );
    });

    document.getElementById("createStationBtn").addEventListener("click", ()=>{
      const name = (document.getElementById("stationName").value || "").trim();
      const precision = document.getElementById("stationPrecision").value;
      if(!name){ toast("Name the station."); return; }
      if(!lastGeo){ toast("Capture coordinates first."); return; }

      const station = {
        id: uid("st"),
        name,
        precision,
        origin: { ...lastGeo },
        testSpots: [],
        createdAt: nowISO(),
        loadout: { phone: navigator.userAgent, externalSensors: [], calibration: "unknown" },
        replicationBeacon: false
      };
      state.stations.unshift(station);
      saveState();

      document.getElementById("stationName").value = "";
      lastGeo = null;
      geoPreview.textContent = "No coordinates yet.";
      toast("Station created.");
      logAccess("write", "station", `create:${station.name}`);
      renderStations();
      refreshStationSelects();
      syncFooter();
    });

    document.getElementById("addTestSpot").addEventListener("click", ()=>{
      if(state.stations.length===0){ toast("Create a station first."); return; }
      if(!lastGeo){ toast("Capture coordinates first (then add a test spot)."); return; }
      const st = state.stations[0]; // add to latest station
      st.testSpots.unshift({ id: uid("spot"), name: `Spot ${st.testSpots.length+1}`, geo: { ...lastGeo } });
      saveState();
      lastGeo = null;
      geoPreview.textContent = "No coordinates yet.";
      toast(`Test spot added to ${st.name}.`);
      logAccess("write", "station", `addSpot:${st.name}`);
      renderStations();
    });

    function renderStations(){
      const list = document.getElementById("stationsList");
      list.innerHTML = "";
      if(state.stations.length===0){
        list.innerHTML = `<div class="item"><p class="itemTitle">No stations yet.</p><p class="small">Create your first station to begin.</p></div>`;
        return;
      }

      state.stations.forEach(st=>{
        const origin = st.origin;
        const dmsLat = formatDMS(origin.lat, true);
        const dmsLon = formatDMS(origin.lon, false);
        const permLabel = st.precision === "public" ? "Public (Approx)" : st.precision === "group" ? "Group (Medium)" : "Private (Exact)";
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="itemTop">
            <div>
              <p class="itemTitle">${escapeHTML(st.name)} <span class="tag ${st.precision==="private"?"green":st.precision==="group"?"amber":"blue"}" style="margin-left:8px;">${permLabel}</span></p>
              <p class="itemMeta">
                DD: lat=${origin.lat.toFixed(8)} lon=${origin.lon.toFixed(8)} • DMS: ${dmsLat} ${dmsLon}
                • hAcc=±${Math.round(origin.accuracy||0)}m
                ${origin.alt!=null ? ` • alt=${origin.alt.toFixed(2)}m` : ``}
                ${origin.altAccuracy!=null ? ` • vAcc=±${Math.round(origin.altAccuracy)}m` : ``}
              </p>
              <p class="small" style="margin-top:8px;">
                Origin pin + ${st.testSpots.length} test spot(s) • Created ${escapeHTML(st.createdAt.slice(0,10))} • Calibration: ${escapeHTML(st.loadout.calibration)}
              </p>
            </div>
            <div class="row">
              <button class="btn" data-openst="${st.id}">Open</button>
              <button class="btn" data-togglebeacon="${st.id}">${st.replicationBeacon ? "Beacon: ON" : "Beacon: OFF"}</button>
              <button class="btn danger" data-delst="${st.id}">Delete</button>
            </div>
          </div>
          <div class="hr"></div>
          <div class="row">
            <span class="chip" data-setactive="${st.id}">Set Active</span>
            <span class="chip" data-calib="${st.id}">Set Calibration</span>
            <span class="chip" data-loadout="${st.id}">Loadout</span>
            <span class="chip" data-exportst="${st.id}">Export</span>
          </div>
        `;
        list.appendChild(el);

        el.querySelector(`[data-delst="${st.id}"]`).addEventListener("click", ()=>{
          state.stations = state.stations.filter(x=>x.id!==st.id);
          state.sessions = state.sessions.filter(s=>s.stationId!==st.id);
          saveState();
          toast("Station deleted.");
          logAccess("delete", "station", `delete:${st.name}`);
          renderStations();
          refreshStationSelects();
          syncFooter();
          renderSessions();
        });

        el.querySelector(`[data-togglebeacon="${st.id}"]`).addEventListener("click", ()=>{
          st.replicationBeacon = !st.replicationBeacon;
          saveState();
          toast(st.replicationBeacon ? "Replication beacon enabled." : "Replication beacon disabled.");
          logAccess("write", "station", `beacon:${st.name}=${st.replicationBeacon}`);
          renderStations();
        });

        el.querySelector(`[data-setactive="${st.id}"]`).addEventListener("click", ()=>{
          state.activeStationId = st.id;
          saveState();
          syncFooter();
          toast(`Active station: ${st.name}`);
          logAccess("write", "station", `active:${st.name}`);
          refreshStationSelects();
        });

        el.querySelector(`[data-calib="${st.id}"]`).addEventListener("click", ()=>{
          const v = prompt("Calibration status (ok / needs_cal / unknown):", st.loadout.calibration || "unknown");
          if(v==null) return;
          st.loadout.calibration = v.trim() || "unknown";
          saveState();
          toast("Calibration updated.");
          logAccess("write", "station", `calibration:${st.name}=${st.loadout.calibration}`);
          renderStations();
        });

        el.querySelector(`[data-loadout="${st.id}"]`).addEventListener("click", ()=>{
          toast("Loadout editing is a future screen (external sensors, RTK profiles, SDR, etc.).");
          logAccess("read", "station", `loadout:${st.name}`);
        });

        el.querySelector(`[data-exportst="${st.id}"]`).addEventListener("click", ()=>{
          exportJSON({
            station: st,
            sessions: state.sessions.filter(s=>s.stationId===st.id),
            exportedAt: nowISO()
          }, `EDEN_station_${safeFile(st.name)}.json`);
          logAccess("export", "station", `export:${st.name}`);
        });

        el.querySelector(`[data-openst="${st.id}"]`).addEventListener("click", ()=>{
          toast("Open Station (demo): use Session Runner below or export.");
          logAccess("read", "station", `open:${st.name}`);
        });
      });

      renderSessions();
    }

    /***********************
     * Sessions
     ************************/
    function refreshStationSelects(){
      const selects = [
        document.getElementById("postStation"),
        document.getElementById("sessionStation"),
        document.getElementById("assetStation")
      ];
      selects.forEach(sel=>{
        sel.innerHTML = "";
        const none = document.createElement("option");
        none.value = "";
        none.textContent = "No Station";
        sel.appendChild(none);

        state.stations.forEach(st=>{
          const opt = document.createElement("option");
          opt.value = st.id;
          opt.textContent = st.name;
          sel.appendChild(opt);
        });

        // default to active station if available
        if(state.activeStationId && state.stations.some(s=>s.id===state.activeStationId)){
          sel.value = state.activeStationId;
        }else{
          sel.value = "";
        }
      });

      // Footer label
      syncFooter();
    }

    document.getElementById("startSession").addEventListener("click", ()=>{
      const stationId = document.getElementById("sessionStation").value || "";
      const protocol = document.getElementById("sessionProtocol").value;
      const notes = (document.getElementById("sessionNotes").value || "").trim();
      const perm = document.getElementById("sessionPermission").value;

      const st = state.stations.find(s=>s.id===stationId);
      const geo = st?.origin || null;

      const session = {
        id: uid("sess"),
        stationId: stationId || null,
        stationName: st?.name || "No Station",
        protocol,
        notes,
        permission: perm,
        utc: nowISO(),
        accuracy: geo?.accuracy ?? null,
        vAccuracy: geo?.altAccuracy ?? null,
        signatureStub: "sig_local_" + Math.random().toString(16).slice(2,10),
        bundleAttached: false
      };

      state.sessions.unshift(session);
      state.sessions = state.sessions.slice(0, 120);
      saveState();

      document.getElementById("sessionNotes").value = "";
      toast("Session started (recorded).");
      logAccess("write", "session", `start:${protocol} @ ${session.stationName}`);
      renderSessions();
    });

    document.getElementById("exportStation").addEventListener("click", ()=>{
      const stationId = document.getElementById("sessionStation").value || "";
      if(!stationId){ toast("Pick a station."); return; }
      const st = state.stations.find(s=>s.id===stationId);
      exportJSON({
        station: st,
        sessions: state.sessions.filter(s=>s.stationId===stationId),
        exportedAt: nowISO()
      }, `EDEN_station_${safeFile(st?.name||"station")}.json`);
      toast("Exported station data.");
      logAccess("export", "station", `exportFromRunner:${st?.name||stationId}`);
    });

    function renderSessions(){
      const list = document.getElementById("sessionsList");
      list.innerHTML = "";
      const recent = state.sessions.slice(0, 18);
      if(recent.length===0){
        list.innerHTML = `<div class="item"><p class="itemTitle">No sessions yet.</p><p class="small">Run a protocol to create a session record.</p></div>`;
        return;
      }
      recent.forEach(s=>{
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="itemTop">
            <div>
              <p class="itemTitle">${escapeHTML(s.protocol)} <span class="tag blue" style="margin-left:8px;">${escapeHTML(s.permission)}</span></p>
              <p class="small">${escapeHTML(s.stationName)} • ${escapeHTML(s.utc.replace("T"," ").replace("Z"," UTC"))}</p>
              <p class="itemMeta">sig=${escapeHTML(s.signatureStub)} • hAcc=${s.accuracy!=null ? "±"+Math.round(s.accuracy)+"m" : "N/A"} • vAcc=${s.vAccuracy!=null ? "±"+Math.round(s.vAccuracy)+"m" : "N/A"}</p>
              ${s.notes ? `<p class="small" style="margin-top:8px;">${escapeHTML(s.notes)}</p>` : ``}
            </div>
            <div class="row">
              <button class="btn" data-bundle="${s.id}">${s.bundleAttached ? "Bundle: ON" : "Attach Bundle"}</button>
              <button class="btn danger" data-delsess="${s.id}">Delete</button>
            </div>
          </div>
        `;
        list.appendChild(el);

        el.querySelector(`[data-bundle="${s.id}"]`).addEventListener("click", ()=>{
          s.bundleAttached = !s.bundleAttached;
          saveState();
          toast(s.bundleAttached ? "Evidence bundle attached (demo)." : "Evidence bundle removed.");
          logAccess("write", "session", `bundle:${s.protocol}=${s.bundleAttached}`);
          renderSessions();
        });

        el.querySelector(`[data-delsess="${s.id}"]`).addEventListener("click", ()=>{
          state.sessions = state.sessions.filter(x=>x.id!==s.id);
          saveState();
          toast("Session deleted.");
          logAccess("delete", "session", `delete:${s.protocol}`);
          renderSessions();
        });
      });
    }

    /***********************
     * POSTS (Research Thread)
     ************************/
    function renderCore(){
      refreshStationSelects();
      renderPosts();
    }

    document.getElementById("addPost").addEventListener("click", ()=>{
      const text = (document.getElementById("postText").value || "").trim();
      if(!text){ toast("Write something."); return; }
      const perm = document.getElementById("postPermission").value;
      const stationId = document.getElementById("postStation").value || null;
      const st = state.stations.find(x=>x.id===stationId);

      state.posts.unshift({
        id: uid("post"),
        text,
        permission: perm,
        stationId,
        stationName: st?.name || "No Station",
        utc: nowISO(),
        signatureStub: "sig_local_" + Math.random().toString(16).slice(2,10),
        evidence: false
      });
      state.posts = state.posts.slice(0, 80);
      saveState();
      document.getElementById("postText").value = "";
      toast("Posted.");
      logAccess("write", "post", `create:${perm} @ ${st?.name||"No Station"}`);
      renderPosts();
    });

    document.getElementById("attachBundle").addEventListener("click", ()=>{
      toast("Attach bundle from the Post card after posting (demo).");
    });

    function renderPosts(){
      const list = document.getElementById("postsList");
      list.innerHTML = "";
      if(state.posts.length===0){
        list.innerHTML = `<div class="item"><p class="itemTitle">No posts yet.</p><p class="small">Write a research thread above.</p></div>`;
        return;
      }
      state.posts.slice(0, 16).forEach(p=>{
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="itemTop">
            <div>
              <p class="itemTitle">${escapeHTML(state.profile.name)} <span class="tag amber" style="margin-left:8px;">${escapeHTML(state.profile.role)}</span> <span class="tag blue" style="margin-left:8px;">${escapeHTML(p.permission)}</span></p>
              <p class="small">${escapeHTML(p.stationName)} • ${escapeHTML(p.utc.replace("T"," ").replace("Z"," UTC"))}</p>
              <p class="p" style="margin-top:8px;">${escapeHTML(p.text)}</p>
              <p class="itemMeta" style="margin-top:8px;">sig=${escapeHTML(p.signatureStub)} • evidence=${p.evidence ? "yes":"no"}</p>
            </div>
            <div class="row">
              <button class="btn" data-ev="${p.id}">${p.evidence ? "Evidence: ON" : "Attach Evidence"}</button>
              <button class="btn danger" data-delpost="${p.id}">Delete</button>
            </div>
          </div>
        `;
        list.appendChild(el);

        el.querySelector(`[data-ev="${p.id}"]`).addEventListener("click", ()=>{
          p.evidence = !p.evidence;
          saveState();
          toast(p.evidence ? "Evidence attached (demo)." : "Evidence removed.");
          logAccess("write", "post", `evidence:${p.id}=${p.evidence}`);
          renderPosts();
        });

        el.querySelector(`[data-delpost="${p.id}"]`).addEventListener("click", ()=>{
          state.posts = state.posts.filter(x=>x.id!==p.id);
          saveState();
          toast("Post deleted.");
          logAccess("delete", "post", `delete:${p.id}`);
          renderPosts();
        });
      });
    }

    /***********************
     * PROFILE (assets + privacy toggles + export/delete)
     ************************/
    function renderProfile(){
      refreshStationSelects();

      document.getElementById("memberName").value = state.profile.name || "Member";
      document.getElementById("memberRole").value = state.profile.role || "Operator";
      document.getElementById("memberVerification").value = state.profile.verification || "Basic Verified";

      document.getElementById("verifTag").textContent = state.profile.verification || "Basic Verified";
      document.getElementById("roleTag").textContent = state.profile.role || "Operator";

      document.getElementById("toggleE2E").textContent = `E2E: ${state.profile.e2e ? "ON":"OFF"}`;
      document.getElementById("toggleDonation").textContent = `Data Donation: ${state.profile.dataDonation ? "ON":"OFF"}`;
      document.getElementById("toggleAudit").textContent = `Audit Log: ${state.profile.auditLog ? "ON":"OFF"}`;

      renderAssets();
      renderAccessLog();
    }

    document.getElementById("saveProfile").addEventListener("click", ()=>{
      state.profile.name = (document.getElementById("memberName").value || "Member").trim() || "Member";
      state.profile.role = document.getElementById("memberRole").value;
      state.profile.verification = document.getElementById("memberVerification").value;
      saveState();
      toast("Profile saved.");
      logAccess("write", "profile", `save:${state.profile.name}/${state.profile.role}`);
      renderProfile();
      renderPosts(); // reflect name/role
    });

    document.getElementById("toggleE2E").addEventListener("click", ()=>{
      state.profile.e2e = !state.profile.e2e;
      saveState();
      toast(`E2E ${state.profile.e2e ? "ON" : "OFF"} (prototype)`);
      logAccess("write", "privacy", `e2e=${state.profile.e2e}`);
      renderProfile();
    });

    document.getElementById("toggleDonation").addEventListener("click", ()=>{
      state.profile.dataDonation = !state.profile.dataDonation;
      saveState();
      toast(`Data donation ${state.profile.dataDonation ? "ON":"OFF"}`);
      logAccess("write", "privacy", `donation=${state.profile.dataDonation}`);
      renderProfile();
    });

    document.getElementById("toggleAudit").addEventListener("click", ()=>{
      state.profile.auditLog = !state.profile.auditLog;
      saveState();
      toast(`Audit log ${state.profile.auditLog ? "ON":"OFF"}`);
      logAccess("write", "privacy", `audit=${state.profile.auditLog}`);
      renderProfile();
    });

    document.getElementById("addAsset").addEventListener("click", ()=>{
      const title = (document.getElementById("assetTitle").value || "").trim();
      if(!title){ toast("Asset needs a title."); return; }
      const type = document.getElementById("assetType").value;
      const perm = document.getElementById("assetPermission").value;
      const stationId = document.getElementById("assetStation").value || null;
      const st = state.stations.find(x=>x.id===stationId);
      const tags = (document.getElementById("assetTags").value || "").split(",").map(x=>x.trim()).filter(Boolean);

      const fileInput = document.getElementById("assetFile");
      const file = fileInput.files && fileInput.files[0];

      // Prototype: store metadata only (not file bytes).
      const asset = {
        id: uid("asset"),
        title,
        type,
        permission: perm,
        stationId,
        stationName: st?.name || "No Station",
        tags,
        fileName: file ? file.name : null,
        size: file ? file.size : null,
        createdAt: nowISO(),
        signatureStub: "sig_local_" + Math.random().toString(16).slice(2,10)
      };
      state.assets.unshift(asset);
      state.assets = state.assets.slice(0, 120);
      saveState();

      document.getElementById("assetTitle").value = "";
      document.getElementById("assetTags").value = "";
      fileInput.value = "";

      toast("Asset added (metadata).");
      logAccess("write", "asset", `add:${asset.title}`);
      renderAssets();
    });

    function renderAssets(){
      const list = document.getElementById("assetsList");
      list.innerHTML = "";
      if(state.assets.length===0){
        list.innerHTML = `<div class="item"><p class="itemTitle">No assets yet.</p><p class="small">Upload files, photos, video, audio, or bundles (metadata in prototype).</p></div>`;
        return;
      }
      state.assets.slice(0, 18).forEach(a=>{
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="itemTop">
            <div>
              <p class="itemTitle">${escapeHTML(a.title)} <span class="tag blue" style="margin-left:8px;">${escapeHTML(a.type)}</span> <span class="tag amber" style="margin-left:8px;">${escapeHTML(a.permission)}</span></p>
              <p class="small">${escapeHTML(a.stationName)} • ${escapeHTML(a.createdAt.slice(0,19).replace("T"," "))} UTC</p>
              <p class="itemMeta">file=${escapeHTML(a.fileName||"N/A")} • size=${a.size!=null ? a.size+"b" : "N/A"} • sig=${escapeHTML(a.signatureStub)}</p>
              ${a.tags?.length ? `<p class="small" style="margin-top:8px;">tags: ${a.tags.map(t=>`<span class="kbd">${escapeHTML(t)}</span>`).join(" ")}</p>` : ``}
            </div>
            <div class="row">
              <button class="btn" data-exportasset="${a.id}">Export</button>
              <button class="btn danger" data-delasset="${a.id}">Delete</button>
            </div>
          </div>
        `;
        list.appendChild(el);

        el.querySelector(`[data-exportasset="${a.id}"]`).addEventListener("click", ()=>{
          exportJSON(a, `EDEN_asset_${safeFile(a.title)}.json`);
          toast("Asset exported (metadata).");
          logAccess("export", "asset", `export:${a.title}`);
        });

        el.querySelector(`[data-delasset="${a.id}"]`).addEventListener("click", ()=>{
          state.assets = state.assets.filter(x=>x.id!==a.id);
          saveState();
          toast("Asset deleted.");
          logAccess("delete", "asset", `delete:${a.title}`);
          renderAssets();
        });
      });
    }

    document.getElementById("exportAll").addEventListener("click", ()=>{
      exportJSON({
        profile: state.profile,
        stacks: state.stacks,
        stations: state.stations,
        sessions: state.sessions,
        posts: state.posts,
        assets: state.assets,
        accessLog: state.accessLog,
        exportedAt: nowISO()
      }, `EDEN_archive_${new Date().toISOString().slice(0,10)}.json`);
      toast("Archive exported.");
      logAccess("export", "archive", "exportAll");
    });

    document.getElementById("hardDeleteAll").addEventListener("click", ()=>{
      const ok = confirm("Hard delete ALL local MAP E.D.E.N. prototype data?");
      if(!ok) return;
      localStorage.removeItem(LS_KEY);
      state = seedState();
      saveState();
      toast("Local data wiped.");
      setActivePanel("hello");
      renderAll();
    });

    function renderAccessLog(){
      const list = document.getElementById("accessLog");
      list.innerHTML = "";
      const logs = state.accessLog || [];
      if(!logs.length){
        list.innerHTML = `<div class="item"><p class="itemTitle">No access events yet.</p><p class="small">Exports/deletes/reads appear here (prototype).</p></div>`;
        return;
      }
      logs.slice(0, 18).forEach(l=>{
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <p class="itemTitle">${escapeHTML(l.type.toUpperCase())} • ${escapeHTML(l.target)}</p>
          <p class="itemMeta">${escapeHTML(l.ts.replace("T"," ").replace("Z"," UTC"))} • ${escapeHTML(l.detail||"")}</p>
        `;
        list.appendChild(el);
      });
    }

    /***********************
     * CLEAR
     ************************/
    document.getElementById("wipeLocal").addEventListener("click", ()=>{
      const ok = confirm("Wipe local prototype data?");
      if(!ok) return;
      localStorage.removeItem(LS_KEY);
      state = seedState();
      saveState();
      toast("Wiped.");
      setActivePanel("hello");
      renderAll();
    });

    document.getElementById("exportBeforeWipe").addEventListener("click", ()=>{
      document.getElementById("exportAll").click();
      toast("Exported. Now you can wipe.");
    });

    /***********************
     * Utility
     ************************/
    function exportJSON(obj, filename){
      const blob = new Blob([JSON.stringify(obj, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 1000);
    }

    function safeFile(s){
      return (s||"file").replace(/[^\w\-]+/g,"_").slice(0,60);
    }

    function escapeHTML(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function syncFooter(){
      const footer = document.getElementById("stationFooter");
      const active = state.stations.find(s=>s.id===state.activeStationId) || state.stations[0];
      if(active){
        footer.textContent = `${active.name} @ ${active.origin.lat.toFixed(2)}°`;
      }else{
        footer.textContent = `Station 0 @ N/A`;
      }
    }

    function renderAll(){
      setMode(state.app.mode || "lite");
      renderStacks();
      renderOverlayLibrary();
      renderStations();
      renderProfile();
      renderPosts();
      refreshStationSelects();
      syncFooter();
    }

    /***********************
     * Initial boot
     ************************/
    // Ensure active stack id
    if(!state.activeStackId && state.stacks.length) state.activeStackId = state.stacks[0].id;

    saveState();
    renderAll();
    setActivePanel(state.app.activePanel || "hello");

    // Keep selects updated
    refreshStationSelects();
    renderSessions();

  </script>
</body>
</html>
