<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>MAP E.D.E.N.</title>
  <meta name="color-scheme" content="dark" />
  <style>
    :root{
      --glass: rgba(12,14,18,0.60);
      --stroke: rgba(255,255,255,0.12);
      --stroke2: rgba(255,255,255,0.16);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.70);
      --muted2: rgba(255,255,255,0.46);
      --green: rgba(120,255,200,0.90);
      --gold: rgba(246,194,74,0.95);
      --blue: rgba(91,188,255,0.92);
      --aqua: rgba(127,255,212,0.92);
      --violet: rgba(160,120,255,0.92);
    }

    html, body { height: 100%; margin: 0; background:#000; overflow:hidden; }
    canvas { display:block; width:100vw !important; height:100vh !important; }

    #openBtn{
      position: fixed;
      left: 18px;
      bottom: 18px;
      z-index: 10000;
      display: none;
      align-items: center;
      padding: 12px 14px;
      border-radius: 18px;
      color: var(--text);
      background: rgba(12,14,18,0.70);
      border: 1px solid rgba(255,255,255,0.14);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 14px 44px rgba(0,0,0,0.42);
      cursor: pointer;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      font: 900 13px/1 -apple-system, system-ui, Segoe UI, Roboto, Arial;
      letter-spacing: 0.35px;
    }
    #openBtn:active { transform: translateY(1px); }

    #drawer{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 18px;
      width: min(820px, calc(100vw - 28px));
      max-height: calc(100vh - 28px);
      z-index: 9999;
      color: var(--text);
      background: var(--glass);
      border: 1px solid var(--stroke);
      border-radius: 22px;
      padding: 14px 14px 12px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 14px 44px rgba(0,0,0,0.42);
      user-select: none;
      overflow: hidden;
    }
    #drawer.closed{
      transform: translateX(-50%) translateY(140%);
      opacity: 0;
      pointer-events: none;
      transition: transform 240ms ease, opacity 200ms ease;
    }
    #drawer:not(.closed){
      transition: transform 240ms ease, opacity 200ms ease;
    }

    #handle{
      width: 44px; height: 6px;
      border-radius: 999px;
      background: rgba(255,255,255,0.18);
      margin: 6px auto 10px;
      cursor: pointer;
    }

    #drawerTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    #titleBlock{
      display:flex;
      flex-direction:column;
      gap:4px;
      padding-right: 8px;
    }
    #title{
      font: 900 18px/1.1 -apple-system, system-ui, Segoe UI, Roboto, Arial;
      letter-spacing: 0.25px;
    }
    #subtitle{
      font: 650 12px/1.25 -apple-system, system-ui, Segoe UI, Roboto, Arial;
      color: var(--muted);
      max-width: 560px;
    }
    #closeBtn{
      width: 40px; height: 40px;
      border-radius: 14px;
      border: 1px solid var(--stroke2);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      -webkit-tap-highlight-color: transparent;
      flex: 0 0 auto;
    }
    #closeBtn:active { transform: translateY(1px); }

    #drawerBody{
      margin-top: 12px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      max-height: calc(100vh - 190px);
      padding-bottom: 6px;
    }

    .gridTop{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 10px;
    }
    .grid2{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .pill{
      width: 100%;
      display:inline-flex;
      align-items:center;
      justify-content: space-between;
      gap:10px;
      padding: 12px 14px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      font: 900 14px/1 -apple-system, system-ui, Segoe UI, Roboto, Arial;
      letter-spacing: 0.15px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .pill:active { transform: translateY(1px); }

    .pill .left{
      display:inline-flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }
    .pill .label{
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .pill .hint{
      font: 800 11px/1.1 -apple-system, system-ui, Segoe UI, Roboto, Arial;
      color: rgba(255,255,255,0.55);
      letter-spacing: 0.1px;
      text-align: right;
    }

    .dot{
      width: 10px; height: 10px;
      border-radius: 50%;
      background: rgba(255,255,255,0.16);
      box-shadow: 0 0 0 rgba(0,0,0,0);
      flex: 0 0 auto;
    }

    .pill.on .dot{
      background: var(--green);
      box-shadow: 0 0 16px rgba(120,255,200,0.24);
    }

    .pill.on[data-key="rhumb222"] .dot{ background: var(--gold); box-shadow:0 0 16px rgba(246,194,74,0.22); }
    .pill.on[data-key="gc222"]    .dot{ background: var(--blue); box-shadow:0 0 16px rgba(91,188,255,0.22); }
    .pill.on[data-key="rhumb42"]  .dot{ background: rgba(246,194,74,0.55); box-shadow:0 0 16px rgba(246,194,74,0.16); }
    .pill.on[data-key="gc42"]     .dot{ background: rgba(91,188,255,0.55); box-shadow:0 0 16px rgba(91,188,255,0.16); }
    .pill.on[data-key="stations"] .dot{ background: var(--aqua); box-shadow:0 0 16px rgba(127,255,212,0.18); }
    .pill.on[data-key="aurora"]   .dot{ background: var(--violet); box-shadow:0 0 16px rgba(160,120,255,0.18); }

    .pill.switch.on{
      border-color: rgba(255,255,255,0.22);
      box-shadow: 0 0 0 1px rgba(255,255,255,0.08) inset, 0 0 28px rgba(255,255,255,0.10);
    }

    #statusBar{
      margin-top: 10px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:center;
      color: var(--muted2);
      font: 800 11px/1.2 -apple-system, system-ui, Segoe UI, Roboto, Arial;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    #errors{
      margin-top: 10px;
      display:none;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,120,120,0.22);
      background: rgba(80,10,10,0.35);
      color: rgba(255,170,170,0.95);
      font: 650 11px/1.35 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      white-space: pre-wrap;
    }

    #drawer.collapsed #drawerBody,
    #drawer.collapsed #statusBar,
    #drawer.collapsed #errors { display:none; }

    #switchboardGroup{ display:none; }
    #switchboardGroup.on{ display:block; }

    #modalMask{
      position: fixed;
      inset: 0;
      z-index: 20000;
      background: rgba(0,0,0,0.62);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
    }
    #modalMask.on{ display:flex; }

    #modal{
      width: min(980px, calc(100vw - 24px));
      height: min(84vh, 780px);
      background: rgba(12,14,18,0.82);
      border: 1px solid rgba(255,255,255,0.16);
      border-radius: 22px;
      box-shadow: 0 20px 70px rgba(0,0,0,0.55);
      overflow: hidden;
      display:flex;
      flex-direction: column;
    }
    #modalTop{
      display:flex;
      align-items:center;
      justify-content: space-between;
      padding: 12px 12px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
    }
    #modalTitle{
      font: 900 14px/1 -apple-system, system-ui, Segoe UI, Roboto, Arial;
      letter-spacing: 0.3px;
      color: rgba(255,255,255,0.92);
      padding-left: 6px;
    }
    #modalClose{
      width: 40px; height: 40px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.92);
      cursor:pointer;
    }
    #modalBody{
      flex: 1 1 auto;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      background: rgba(0,0,0,0.15);
    }
    #welcomeFrame{
      width: 100%;
      height: 100%;
      border: 0;
      display:block;
      background: #000;
    }
    #missionContent{
      padding: 18px 18px 24px;
      color: rgba(255,255,255,0.88);
      font: 650 14px/1.55 -apple-system, system-ui, Segoe UI, Roboto, Arial;
      max-width: 920px;
      margin: 0 auto;
      display:none;
    }
    #missionContent h2{
      font: 900 18px/1.2 -apple-system, system-ui, Segoe UI, Roboto, Arial;
      margin: 0 0 10px;
      letter-spacing: 0.2px;
    }
    #missionContent p{ margin: 0 0 12px; color: rgba(255,255,255,0.80); }

    @media (max-width: 520px){
      .pill{ padding: 12px 12px; border-radius: 16px; font-size: 13px; }
      #drawerBody{ max-height: calc(100vh - 200px); }
      #subtitle{ max-width: 310px; }
      .pill .hint{ display:none; }
    }
    @media (max-width: 380px){
      .gridTop{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <button id="openBtn" aria-label="Open MAP E.D.E.N.">MAP E.D.E.N.</button>

  <div id="drawer">
    <div id="handle" title="Tap to collapse/expand"></div>

    <div id="drawerTop">
      <div id="titleBlock">
        <div id="title">MAP E.D.E.N.</div>
        <div id="subtitle">Earth Diametric Energy Network • Tap Switchboard to open layers</div>
      </div>
      <button id="closeBtn" aria-label="Close drawer" title="Close">✕</button>
    </div>

    <div id="drawerBody">
      <div class="gridTop">
        <button class="pill" id="welcomeBtn">
          <span class="left"><span class="dot"></span><span class="label">Welcome</span></span>
        </button>

        <button class="pill" id="missionBtn">
          <span class="left"><span class="dot"></span><span class="label">Mission</span></span>
        </button>

        <button class="pill switch" id="switchboardBtn">
          <span class="left"><span class="dot"></span><span class="label">Switchboard</span></span>
          <span class="hint" id="switchHint">Tap to open</span>
        </button>
      </div>

      <div id="switchboardGroup">
        <div class="grid2">
          <button class="pill on" data-key="rhumb222"><span class="left"><span class="dot"></span><span class="label">Rhumb 222 SW</span></span></button>
          <button class="pill" data-key="rhumb42"><span class="left"><span class="dot"></span><span class="label">Rhumb 42 NE</span></span></button>

          <button class="pill on" data-key="gc222"><span class="left"><span class="dot"></span><span class="label">Great Circle 222 SW</span></span></button>
          <button class="pill" data-key="gc42"><span class="left"><span class="dot"></span><span class="label">Great Circle 42 NE</span></span></button>

          <button class="pill" data-key="names222"><span class="left"><span class="dot"></span><span class="label">Names 222 SW</span></span></button>
          <button class="pill" data-key="names42"><span class="left"><span class="dot"></span><span class="label">Names 42 NE</span></span></button>

          <button class="pill" data-key="perp"><span class="left"><span class="dot"></span><span class="label">Perpendiculars 132/312</span></span></button>
          <button class="pill" data-key="night"><span class="left"><span class="dot"></span><span class="label">Night Lights</span></span></button>

          <button class="pill on" data-key="stations"><span class="left"><span class="dot"></span><span class="label">Stations</span></span></button>
          <button class="pill" data-key="aurora"><span class="left"><span class="dot"></span><span class="label">Aurora</span></span></button>
        </div>
      </div>

      <div id="errors"></div>
    </div>

    <div id="statusBar">
      <span id="status">Booting…</span>
      <span id="stationText">Exit 222 • Station 1 @ 38°9′39″ N, 79°4′24″ W</span>
    </div>
  </div>

  <div id="modalMask" role="dialog" aria-modal="true" aria-label="MAP E.D.E.N. Modal">
    <div id="modal">
      <div id="modalTop">
        <div id="modalTitle">WELCOME</div>
        <button id="modalClose" aria-label="Close modal">✕</button>
      </div>
      <div id="modalBody">
        <iframe id="welcomeFrame" title="MAP E.D.E.N. Welcome" loading="lazy"></iframe>

        <div id="missionContent">
          <h2>MISSION</h2>
          <p>MAP E.D.E.N. is the operational field platform for Project E.D.E.N. (Earth Diametric &amp; Energy Network)—a secure, repeatable way to run real-world tests along defined Earth corridors, beginning with the 42/222 diametric axis (42° and 222° are opposite bearings on the same straight line). Based on a 20+ year personal observation record, the Founder identified “222” as a persistent recurring numeric event marker across routine environments (time displays, identifiers, signage). This long-duration recurrence served as the initial trigger for structuring Project E.D.E.N. as a measurement-first field program.</p>
          <p>Over time, and in multiple documented sessions, the “222” event marker also coincided with a compass bearing of 222° (SW)—reinforcing the 42/222 line as a repeatable corridor for formal testing. MAP E.D.E.N. equips trusted operators with clear protocols to collect environmental field measurements and navigation-behavior observations, including human biological magnetoreception and magnetically influenced orientation, homing, and migratory navigation in animals and insects, so results can be compared across time.</p>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import * as THREE from "https://unpkg.com/three@0.161.0/build/three.module.js";

    // ---------- UI refs ----------
    const statusEl   = document.getElementById("status");
    const errorsEl   = document.getElementById("errors");
    const drawerEl   = document.getElementById("drawer");
    const openBtn    = document.getElementById("openBtn");
    const closeBtn   = document.getElementById("closeBtn");
    const handle     = document.getElementById("handle");

    const welcomeBtn = document.getElementById("welcomeBtn");
    const missionBtn = document.getElementById("missionBtn");
    const switchBtn  = document.getElementById("switchboardBtn");
    const switchHint = document.getElementById("switchHint");
    const switchGrp  = document.getElementById("switchboardGroup");

    const modalMask  = document.getElementById("modalMask");
    const modalClose = document.getElementById("modalClose");
    const modalTitle = document.getElementById("modalTitle");
    const welcomeFrame = document.getElementById("welcomeFrame");
    const missionContent = document.getElementById("missionContent");

    const layerButtons = {
      rhumb222: document.querySelector('.pill[data-key="rhumb222"]'),
      rhumb42:  document.querySelector('.pill[data-key="rhumb42"]'),
      gc222:    document.querySelector('.pill[data-key="gc222"]'),
      gc42:     document.querySelector('.pill[data-key="gc42"]'),
      names222: document.querySelector('.pill[data-key="names222"]'),
      names42:  document.querySelector('.pill[data-key="names42"]'),
      perp:     document.querySelector('.pill[data-key="perp"]'),
      night:    document.querySelector('.pill[data-key="night"]'),
      stations: document.querySelector('.pill[data-key="stations"]'),
      aurora:   document.querySelector('.pill[data-key="aurora"]'),
    };

    function showError(msg){
      errorsEl.style.display = "block";
      errorsEl.textContent += (errorsEl.textContent ? "\n\n" : "") + msg;
      statusEl.textContent = "Error (see panel)";
    }
    function fmtErr(e){
      if (!e) return "Unknown error";
      if (typeof e === "string") return e;
      if (e instanceof Error) return e.stack || e.message;
      if (e.type) return `Event type="${e.type}" (likely a failed network/image load)`;
      try { return JSON.stringify(e); } catch { return String(e); }
    }
    window.addEventListener("error", (e) => showError("JS Error:\n" + (e.message || fmtErr(e.error || e))));
    window.addEventListener("unhandledrejection", (e) => showError("Promise Rejection:\n" + fmtErr(e.reason)));

    function setTopBtnOn(btn, isOn){ btn?.classList.toggle("on", !!isOn); }

    function setDrawerClosed(isClosed){
      drawerEl.classList.toggle("closed", !!isClosed);
      openBtn.style.display = isClosed ? "inline-flex" : "none";
    }
    setDrawerClosed(false);
    openBtn.addEventListener("click", () => setDrawerClosed(false));
    closeBtn.addEventListener("click", () => setDrawerClosed(true));
    handle.addEventListener("click", () => drawerEl.classList.toggle("collapsed"));

    // Modal
    function openModal(kind){
      modalMask.classList.add("on");
      setTopBtnOn(welcomeBtn, kind === "welcome");
      setTopBtnOn(missionBtn, kind === "mission");

      if (kind === "welcome"){
        modalTitle.textContent = "WELCOME";
        missionContent.style.display = "none";
        welcomeFrame.style.display = "block";
        welcomeFrame.src = "welcome.html";
        welcomeFrame.onerror = () => {
          welcomeFrame.srcdoc =
            "<!doctype html><html><body style='background:#000;color:#fff;font-family:-apple-system,system-ui;padding:20px'>" +
            "<h2>WELCOME</h2><p>Could not load <b>welcome.html</b>. Ensure it is in the repo root next to <b>index.html</b>.</p>" +
            "</body></html>";
        };
      } else {
        modalTitle.textContent = "MISSION";
        welcomeFrame.style.display = "none";
        missionContent.style.display = "block";
      }
    }
    function closeModal(){
      modalMask.classList.remove("on");
      setTopBtnOn(welcomeBtn, false);
      setTopBtnOn(missionBtn, false);
      if (welcomeFrame.style.display !== "none") welcomeFrame.src = "about:blank";
    }
    modalClose.addEventListener("click", closeModal);
    modalMask.addEventListener("click", (e)=>{ if(e.target === modalMask) closeModal(); });
    welcomeBtn.addEventListener("click", ()=>openModal("welcome"));
    missionBtn.addEventListener("click", ()=>openModal("mission"));

    // Switchboard
    let switchboardOn = false;
    function setSwitchboard(on){
      switchboardOn = !!on;
      switchBtn.classList.toggle("on", switchboardOn);
      switchGrp.classList.toggle("on", switchboardOn);
      switchHint.textContent = switchboardOn ? "Tap to close" : "Tap to open";
    }
    switchBtn.addEventListener("click", ()=> setSwitchboard(!switchboardOn));
    setSwitchboard(false);

    // ---------- THREE scene ----------
    statusEl.textContent = "Starting…";

    // WebGL guard
    const testCanvas = document.createElement("canvas");
    const gl = testCanvas.getContext("webgl") || testCanvas.getContext("experimental-webgl");
    if (!gl){
      showError("WebGL is not available on this device/browser.");
      throw new Error("WebGL not available");
    }

    const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:false, powerPreference:"high-performance" });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setClearColor(0x000000, 1);
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    document.body.appendChild(renderer.domElement);

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(42, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0, 0, 3.0);

    const group = new THREE.Group();
    scene.add(group);

    const sun = new THREE.DirectionalLight(0xffffff, 1.35);
    sun.position.set(5, 2, 5);
    scene.add(sun);
    scene.add(new THREE.AmbientLight(0xffffff, 0.28));

    const DEG = Math.PI/180;
    const RAD = 180/Math.PI;
    const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));

    function isUI(target){
      return !!(target && (target.closest?.("#drawer") || target.closest?.("#openBtn") || target.closest?.("#modalMask")));
    }

    function latLonToVec3(latDeg, lonDeg, r=1){
      const lat = latDeg * DEG;
      const lon = lonDeg * DEG;
      return new THREE.Vector3(
        r * Math.cos(lat) * Math.cos(lon),
        r * Math.sin(lat),
        r * Math.cos(lat) * Math.sin(lon)
      );
    }

    function greatCirclePoints(lat0Deg, lon0Deg, bearingDeg, stepDeg=1.0){
      const lat0 = lat0Deg * DEG;
      const lon0 = lon0Deg * DEG;
      const brng = bearingDeg * DEG;

      const pts = [];
      for(let d=-180; d<=180; d+=stepDeg){
        const δ = d * DEG;
        const sinLat = Math.sin(lat0)*Math.cos(δ) + Math.cos(lat0)*Math.sin(δ)*Math.cos(brng);
        const lat = Math.asin(clamp(sinLat, -1, 1));
        const y = Math.sin(brng)*Math.sin(δ)*Math.cos(lat0);
        const x = Math.cos(δ) - Math.sin(lat0)*Math.sin(lat);
        const lon = lon0 + Math.atan2(y, x);
        pts.push({ lat: lat*RAD, lon: ((lon*RAD + 540) % 360) - 180 });
      }
      return pts;
    }

    function rhumbLinePoints(lat0Deg, lon0Deg, bearingDeg, stepKm=160, steps=140){
      const R = 6371;
      const brng = bearingDeg * DEG;

      let lat = lat0Deg * DEG;
      let lon = lon0Deg * DEG;

      const pts = [{lat: lat0Deg, lon: lon0Deg}];
      for(let i=0;i<steps;i++){
        const d = (stepKm / R);
        const dLat = d * Math.cos(brng);
        const lat2 = lat + dLat;
        const lat2c = clamp(lat2, -Math.PI/2 + 1e-6, Math.PI/2 - 1e-6);

        const dPsi = Math.log(Math.tan(Math.PI/4 + lat2c/2) / Math.tan(Math.PI/4 + lat/2));
        const q = (Math.abs(dPsi) > 1e-12) ? (dLat / dPsi) : Math.cos(lat);

        const dLon = d * Math.sin(brng) / q;
        const lon2 = lon + dLon;

        lat = lat2c;
        lon = lon2;

        pts.push({ lat: lat*RAD, lon: ((lon*RAD + 540) % 360) - 180 });
      }
      return pts;
    }

    function buildLine(points, color, opacity){
      const geom = new THREE.BufferGeometry();
      const verts = new Float32Array(points.length * 3);
      const r = 1.002;
      for(let i=0;i<points.length;i++){
        const v = latLonToVec3(points[i].lat, points[i].lon, r);
        verts[i*3+0] = v.x;
        verts[i*3+1] = v.y;
        verts[i*3+2] = v.z;
      }
      geom.setAttribute("position", new THREE.BufferAttribute(verts, 3));
      const mat = new THREE.LineBasicMaterial({ color, transparent:true, opacity });
      return new THREE.Line(geom, mat);
    }

    function makeTextSprite(text, rgba="255,255,255,0.95"){
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");
      const pad = 18;

      ctx.font = "900 36px -apple-system, system-ui, Segoe UI, Roboto, Arial";
      const w = Math.ceil(ctx.measureText(text).width) + pad*2;
      const h = 64;
      canvas.width = w;
      canvas.height = h;

      ctx.font = "900 36px -apple-system, system-ui, Segoe UI, Roboto, Arial";
      ctx.fillStyle = "rgba(0,0,0,0.55)";
      ctx.fillRect(0,0,w,h);
      ctx.fillStyle = "rgba(" + rgba + ")";
      ctx.textBaseline = "middle";
      ctx.fillText(text, pad, h/2);

      const tex = new THREE.CanvasTexture(canvas);
      tex.colorSpace = THREE.SRGBColorSpace;
      const mat = new THREE.SpriteMaterial({ map: tex, transparent:true, depthWrite:false });
      const spr = new THREE.Sprite(mat);
      spr.scale.set(0.58*(w/h), 0.58, 1);
      return spr;
    }

    // Station 1 (Exit 222)
    const STATION1 = { lat: 38 + 9/60 + 39/3600, lon: -(79 + 4/60 + 24/3600) };

    // IMPORTANT FIX: use stable texture host (threejs.org)
    const TEX = "https://threejs.org/examples/textures/planets/";

    const loader = new THREE.TextureLoader();
    loader.crossOrigin = "anonymous";

    function loadTex(url){
      return new Promise((resolve, reject)=>{
        loader.load(
          url,
          (t)=>resolve(t),
          undefined,
          (e)=>reject({ url, event: e })
        );
      });
    }

    async function tryLoadTex(url, label){
      try{
        const t = await loadTex(url);
        t.colorSpace = THREE.SRGBColorSpace;
        return t;
      }catch(err){
        showError(`Texture failed: ${label}\n${url}\n${fmtErr(err?.event || err)}`);
        return null; // continue with fallback
      }
    }

    const overlays = new THREE.Group();
    group.add(overlays);

    const labelGroup = new THREE.Group();
    overlays.add(labelGroup);

    const stationGroup = new THREE.Group();
    overlays.add(stationGroup);

    const perpGroup = new THREE.Group();
    overlays.add(perpGroup);

    const auroraGroup = new THREE.Group();
    overlays.add(auroraGroup);

    let earthMesh = null;
    let nightShell = null;

    (async()=>{
      try{
        statusEl.textContent = "Loading textures…";

        const day    = await tryLoadTex(TEX + "earth_atmos_2048.jpg", "Day (earth_atmos_2048)");
        const normal = await tryLoadTex(TEX + "earth_normal_2048.jpg", "Normal (earth_normal_2048)");
        const spec   = await tryLoadTex(TEX + "earth_specular_2048.jpg", "Specular (earth_specular_2048)");

        const clouds = await tryLoadTex(TEX + "earth_clouds_1024.png", "Clouds (earth_clouds_1024)") ;
        const night  = await tryLoadTex(TEX + "earth_lights_2048.png", "Night lights (earth_lights_2048)") ;

        statusEl.textContent = "Building globe…";

        const radius = 1.0;
        const geo = new THREE.SphereGeometry(radius, 64, 64);

        // Fallback-safe material
        const earthMat = new THREE.MeshPhongMaterial({
          color: day ? 0xffffff : 0x223355,
          map: day || null,
          normalMap: normal || null,
          specularMap: spec || null,
          specular: new THREE.Color(0x222222),
          shininess: 18
        });

        earthMesh = new THREE.Mesh(geo, earthMat);
        group.add(earthMesh);

        // night shell (additive)
        if (night){
          const nightMat = new THREE.MeshBasicMaterial({
            map: night,
            transparent: true,
            opacity: 0.38,
            blending: THREE.AdditiveBlending,
            depthWrite: false
          });
          nightShell = new THREE.Mesh(new THREE.SphereGeometry(radius*1.0006, 64, 64), nightMat);
          overlays.add(nightShell);
        }

        // clouds
        if (clouds){
          const cloudMat = new THREE.MeshLambertMaterial({
            map: clouds,
            transparent: true,
            opacity: 0.35,
            depthWrite: false
          });
          const cloudMesh = new THREE.Mesh(new THREE.SphereGeometry(radius*1.006, 64, 64), cloudMat);
          group.add(cloudMesh);
          cloudMesh.userData.spin = 0.0016;
          scene.userData.cloudMesh = cloudMesh;
        }

        // atmosphere glow
        const atmoGeo = new THREE.SphereGeometry(radius*1.02, 64, 64);
        const atmoMat = new THREE.ShaderMaterial({
          transparent: true,
          blending: THREE.AdditiveBlending,
          depthWrite: false,
          uniforms: {
            c: { value: 0.6 },
            p: { value: 2.3 },
            glowColor: { value: new THREE.Color(0x4aa3ff) },
            viewVector: { value: camera.position.clone() }
          },
          vertexShader: `
            uniform vec3 viewVector;
            uniform float c;
            uniform float p;
            varying float intensity;
            void main(){
              vec3 vNormal = normalize(normalMatrix * normal);
              vec3 vNormel = normalize(normalMatrix * viewVector);
              intensity = pow(c - dot(vNormal, vNormel), p);
              gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0);
            }
          `,
          fragmentShader: `
            uniform vec3 glowColor;
            varying float intensity;
            void main(){
              gl_FragColor = vec4(glowColor, intensity);
            }
          `
        });
        const atmo = new THREE.Mesh(atmoGeo, atmoMat);
        group.add(atmo);
        scene.userData.atmo = atmo;

        // Lines
        const rh222 = buildLine(rhumbLinePoints(STATION1.lat, STATION1.lon, 222), 0xF6C24A, 0.95);
        const rh42  = buildLine(rhumbLinePoints(STATION1.lat, STATION1.lon, 42),  0xF6C24A, 0.32);
        const gc222 = buildLine(greatCirclePoints(STATION1.lat, STATION1.lon, 222, 1), 0x5BBCFF, 0.95);
        const gc42  = buildLine(greatCirclePoints(STATION1.lat, STATION1.lon, 42,  1), 0x5BBCFF, 0.32);
        overlays.add(rh222, rh42, gc222, gc42);

        // Labels
        const lab222 = makeTextSprite("222° SW", "246,194,74,0.98");
        lab222.position.copy(latLonToVec3(STATION1.lat - 8, STATION1.lon - 8, 1.09));
        labelGroup.add(lab222);

        const lab42 = makeTextSprite("42° NE", "91,188,255,0.98");
        lab42.position.copy(latLonToVec3(STATION1.lat + 10, STATION1.lon + 10, 1.09));
        labelGroup.add(lab42);

        // Station marker
        const dot = new THREE.Mesh(
          new THREE.SphereGeometry(0.013, 18, 18),
          new THREE.MeshBasicMaterial({ color: 0x7FFFD4 })
        );
        dot.position.copy(latLonToVec3(STATION1.lat, STATION1.lon, 1.01));
        stationGroup.add(dot);

        const stLab = makeTextSprite("Station 1", "127,255,212,0.98");
        stLab.position.copy(latLonToVec3(STATION1.lat+2.2, STATION1.lon-2.5, 1.07));
        stationGroup.add(stLab);

        // Perpendiculars
        const p132 = buildLine(greatCirclePoints(STATION1.lat, STATION1.lon, 132, 2).slice(60, 90), 0xffffff, 0.35);
        const p312 = buildLine(greatCirclePoints(STATION1.lat, STATION1.lon, 312, 2).slice(60, 90), 0xffffff, 0.35);
        perpGroup.add(p132, p312);

        // Aurora ring
        const aurora = new THREE.Mesh(
          new THREE.TorusGeometry(1.08, 0.035, 18, 220),
          new THREE.MeshBasicMaterial({ color: 0xA078FF, transparent:true, opacity: 0.10, blending: THREE.AdditiveBlending, depthWrite:false })
        );
        aurora.rotation.x = Math.PI/2;
        aurora.rotation.y = Math.PI/6;
        auroraGroup.add(aurora);

        // Initial visibility
        rh222.visible = true;
        gc222.visible = true;
        rh42.visible  = false;
        gc42.visible  = false;

        labelGroup.visible = false;
        stationGroup.visible = true;
        perpGroup.visible = false;
        auroraGroup.visible = false;
        if (nightShell) nightShell.visible = true;

        const state = {
          rhumb222: true,
          rhumb42: false,
          gc222: true,
          gc42: false,
          names222: false,
          names42: false,
          perp: false,
          night: true,
          stations: true,
          aurora: false
        };

        function setBtn(key, on){
          state[key] = !!on;
          layerButtons[key]?.classList.toggle("on", !!on);
        }
        function bind(key, fn){
          layerButtons[key]?.addEventListener("click", ()=>{
            const on = !state[key];
            setBtn(key, on);
            fn(on);
          });
        }

        bind("rhumb222", (on)=> rh222.visible = on);
        bind("rhumb42",  (on)=> rh42.visible  = on);
        bind("gc222",    (on)=> gc222.visible = on);
        bind("gc42",     (on)=> gc42.visible  = on);

        bind("names222", (on)=> { labelGroup.visible = on || state.names42; });
        bind("names42",  (on)=> { labelGroup.visible = on || state.names222; });

        bind("perp",     (on)=> perpGroup.visible = on);
        bind("night",    (on)=> { if (nightShell) nightShell.visible = on; });
        bind("stations", (on)=> stationGroup.visible = on);
        bind("aurora",   (on)=> auroraGroup.visible  = on);

        Object.keys(state).forEach(k => setBtn(k, state[k]));

        statusEl.textContent = "Running";

        // Interaction
        let dragging = false;
        let lastX=0, lastY=0;
        let velX=0, velY=0;
        const ROT_SPEED = 0.005;
        const DAMP = 0.92;
        const MAX_PITCH = Math.PI/2.4;
        const AUTO_SPIN = 0.00025;

        let pinching = false;
        let startDist=0;
        let startZ = camera.position.z;
        const Z_MIN = 1.85, Z_MAX = 5.0;

        function dist(t1,t2){
          const dx = t1.clientX - t2.clientX;
          const dy = t1.clientY - t2.clientY;
          return Math.sqrt(dx*dx + dy*dy);
        }

        renderer.domElement.addEventListener("pointerdown", (e)=>{
          if (isUI(e.target)) return;
          dragging = true;
          lastX = e.clientX;
          lastY = e.clientY;
          renderer.domElement.setPointerCapture?.(e.pointerId);
        }, { passive:true });

        renderer.domElement.addEventListener("pointermove", (e)=>{
          if (!dragging || isUI(e.target)) return;
          const dx = e.clientX - lastX;
          const dy = e.clientY - lastY;
          lastX = e.clientX;
          lastY = e.clientY;

          velY = dx * ROT_SPEED;
          velX = dy * ROT_SPEED;

          group.rotation.y += velY;
          group.rotation.x = clamp(group.rotation.x + velX, -MAX_PITCH, MAX_PITCH);
        }, { passive:true });

        renderer.domElement.addEventListener("pointerup", ()=> dragging = false, { passive:true });
        renderer.domElement.addEventListener("pointercancel", ()=> dragging = false, { passive:true });

        renderer.domElement.addEventListener("touchstart", (e)=>{
          if (isUI(e.target)) return;
          if (e.touches.length === 2){
            pinching = true;
            startDist = dist(e.touches[0], e.touches[1]);
            startZ = camera.position.z;
          }
        }, { passive:true });

        renderer.domElement.addEventListener("touchmove", (e)=>{
          if (!pinching || isUI(e.target)) return;
          if (e.touches.length === 2){
            const d = dist(e.touches[0], e.touches[1]);
            const scale = startDist / d;
            camera.position.z = clamp(startZ * scale, Z_MIN, Z_MAX);
          }
        }, { passive:true });

        renderer.domElement.addEventListener("touchend", (e)=>{
          if (e.touches.length < 2) pinching = false;
        }, { passive:true });

        window.addEventListener("wheel", (e)=>{
          if (isUI(e.target)) return;
          camera.position.z = clamp(camera.position.z + (e.deltaY * 0.0025), Z_MIN, Z_MAX);
        }, { passive:true });

        // Resize
        let resizeTimer=0;
        function doResize(){
          const w = Math.max(1, window.innerWidth);
          const h = Math.max(1, window.innerHeight);
          camera.aspect = w/h;
          camera.updateProjectionMatrix();
          renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));
          renderer.setSize(w, h, false);
        }
        function scheduleResize(){
          clearTimeout(resizeTimer);
          resizeTimer = setTimeout(()=> requestAnimationFrame(doResize), 160);
        }
        window.addEventListener("resize", scheduleResize, { passive:true });
        window.addEventListener("orientationchange", scheduleResize, { passive:true });

        // Render loop
        let running = true;
        let rafId = 0;

        function animate(){
          if (!running){ rafId = 0; return; }
          rafId = requestAnimationFrame(animate);

          const cloudMesh = scene.userData.cloudMesh;
          if (cloudMesh) cloudMesh.rotation.y += cloudMesh.userData.spin || 0.0014;

          const atmo = scene.userData.atmo;
          if (atmo?.material?.uniforms?.viewVector){
            atmo.material.uniforms.viewVector.value.copy(camera.position);
          }

          if(!dragging && !pinching){
            group.rotation.y += AUTO_SPIN + velY;
            group.rotation.x = clamp(group.rotation.x + velX, -MAX_PITCH, MAX_PITCH);
            velY *= DAMP;
            velX *= DAMP;
          }

          renderer.render(scene, camera);
        }
        animate();

        document.addEventListener("visibilitychange", ()=>{
          running = !document.hidden;
          if (running && !rafId) animate();
        });

      } catch (err){
        showError("Top-level error:\n" + fmtErr(err));
      }
    })();
  </script>
</body>
</html>
