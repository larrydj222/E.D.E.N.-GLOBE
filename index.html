<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="referrer" content="no-referrer" />
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    img-src 'self' data: https:;
    style-src 'self' 'unsafe-inline';
    script-src 'self' https://unpkg.com https://cdn.jsdelivr.net https://threejs.org 'unsafe-inline';
    connect-src 'self' https://unpkg.com https://cdn.jsdelivr.net https://threejs.org;
    frame-src 'self';
    font-src 'self' data:;
  " />
  <title>MAP E.D.E.N. Globe</title>

  <style>
    :root{
      --glass: rgba(12,14,18,0.60);
      --stroke: rgba(255,255,255,0.12);
      --stroke2: rgba(255,255,255,0.14);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.70);
      --muted2: rgba(255,255,255,0.46);
      --gold: #f6c24a;
      --blue: #5bbcff;
      --aqua: #7fffd4;
      --violet:#a078ff;
      --ok: rgba(120,255,200,0.88);
      --danger: rgba(255,120,120,0.92);
      --shadow: 0 14px 44px rgba(0,0,0,0.42);
    }

    html, body { height: 100%; margin: 0; background:#000; overflow:hidden; touch-action:none; }
    canvas { display:block; width:100vw !important; height:100vh !important; }

    #openBtn{
      position: fixed;
      left: 18px;
      bottom: 18px;
      z-index: 10000;
      display: none;
      align-items: center;
      padding: 12px 14px;
      border-radius: 18px;
      color: var(--text);
      background: rgba(12,14,18,0.62);
      border: 1px solid rgba(255,255,255,0.14);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      cursor: pointer;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      font: 900 13px/1 -apple-system, system-ui, Segoe UI, Roboto, Arial;
      letter-spacing: 0.35px;
    }
    #openBtn:active { transform: translateY(1px); }

    #drawer {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 18px;
      width: min(820px, calc(100vw - 28px));
      max-height: calc(100vh - 28px);
      z-index: 9999;
      color: var(--text);
      background: var(--glass);
      border: 1px solid var(--stroke);
      border-radius: 22px;
      padding: 14px 14px 12px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      user-select: none;
      overflow: hidden;
    }

    #drawer.closed{
      transform: translateX(-50%) translateY(140%);
      opacity: 0;
      pointer-events: none;
      transition: transform 240ms ease, opacity 200ms ease;
    }
    #drawer:not(.closed){
      transition: transform 240ms ease, opacity 200ms ease;
    }

    #handle {
      width: 44px;
      height: 6px;
      border-radius: 999px;
      background: rgba(255,255,255,0.18);
      margin: 6px auto 10px;
      cursor: pointer;
    }

    #drawerTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    #titleBlock{
      display:flex;
      flex-direction:column;
      gap:4px;
      padding-right: 8px;
    }
    #title {
      font: 900 18px/1.1 -apple-system, system-ui, Segoe UI, Roboto, Arial;
      letter-spacing: 0.25px;
    }
    #subtitle{
      font: 650 12px/1.25 -apple-system, system-ui, Segoe UI, Roboto, Arial;
      color: var(--muted);
      max-width: 540px;
    }

    #closeBtn{
      width: 40px;
      height: 40px;
      border-radius: 14px;
      border: 1px solid var(--stroke2);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      -webkit-tap-highlight-color: transparent;
      flex: 0 0 auto;
    }
    #closeBtn:active { transform: translateY(1px); }

    #drawerBody{
      margin-top: 12px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      max-height: calc(100vh - 190px);
      padding-bottom: 6px;
    }

    .gridTop{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 10px;
    }

    .grid2{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .pill {
      width: 100%;
      display:inline-flex;
      align-items:center;
      justify-content: space-between;
      gap:10px;
      padding: 12px 14px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      font: 900 14px/1 -apple-system, system-ui, Segoe UI, Roboto, Arial;
      letter-spacing: 0.15px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .pill:active { transform: translateY(1px); }
    .pill[disabled]{ opacity:0.55; cursor: not-allowed; }

    .pill .left{
      display:inline-flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }
    .pill .label{
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .pill .hint{
      font: 800 11px/1.1 -apple-system, system-ui, Segoe UI, Roboto, Arial;
      color: rgba(255,255,255,0.55);
      letter-spacing: 0.1px;
      text-align: right;
    }

    .dot {
      width: 10px; height: 10px;
      border-radius: 50%;
      background: rgba(255,255,255,0.16);
      box-shadow: 0 0 0 rgba(0,0,0,0);
      flex: 0 0 auto;
    }

    /* ‚ÄúLights turn green‚Äù when a TOP button is pressed (Welcome/Mission/Station) */
    .pill.on .dot{ background: var(--ok); box-shadow: 0 0 16px rgba(120,255,200,0.24); }

    /* Overlay color accents (library) */
    .pill.on[data-key="rhumb222"] .dot{ background: rgba(246,194,74,0.95); box-shadow:0 0 16px rgba(246,194,74,0.22); }
    .pill.on[data-key="gc222"]    .dot{ background: rgba(91,188,255,0.92); box-shadow:0 0 16px rgba(91,188,255,0.22); }
    .pill.on[data-key="rhumb42"] .dot{ background: rgba(246,194,74,0.55); box-shadow:0 0 16px rgba(246,194,74,0.16); }
    .pill.on[data-key="gc42"]    .dot{ background: rgba(91,188,255,0.55); box-shadow:0 0 16px rgba(91,188,255,0.16); }
    .pill.on[data-key="stations"]   .dot{ background: rgba(127,255,212,0.90); box-shadow:0 0 16px rgba(127,255,212,0.18); }
    .pill.on[data-key="aurora"]     .dot{ background: rgba(160,120,255,0.92); box-shadow:0 0 16px rgba(160,120,255,0.18); }
    .pill.on[data-key="nightLights"].dot{ background: rgba(140,255,200,0.92); box-shadow:0 0 16px rgba(140,255,200,0.18); }

    #statusBar{
      margin-top: 10px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:center;
      color: var(--muted2);
      font: 800 11px/1.2 -apple-system, system-ui, Segoe UI, Roboto, Arial;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    #errors{
      margin-top: 10px;
      display:none;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,120,120,0.22);
      background: rgba(80,10,10,0.35);
      color: rgba(255,170,170,0.95);
      font: 650 11px/1.35 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      white-space: pre-wrap;
    }

    #drawer.collapsed #drawerBody,
    #drawer.collapsed #statusBar,
    #drawer.collapsed #errors { display:none; }
    #drawer.collapsed { padding-bottom: 12px; }

    /* Station group (your ‚ÄúSwitchboard‚Äù replacement) */
    #stationGroup{ display:none; }
    #stationGroup.on{ display:block; }

    /* Full-screen modal system */
    #modalMask{
      position: fixed;
      inset: 0;
      z-index: 20000;
      background: rgba(0,0,0,0.62);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
    }
    #modalMask.on{ display:flex; }

    #modal{
      width: min(980px, calc(100vw - 24px));
      height: min(86vh, 820px);
      background: rgba(12,14,18,0.78);
      border: 1px solid rgba(255,255,255,0.16);
      border-radius: 22px;
      box-shadow: 0 20px 70px rgba(0,0,0,0.55);
      overflow: hidden;
      display:flex;
      flex-direction: column;
    }

    #modalTop{
      display:flex;
      align-items:center;
      justify-content: space-between;
      padding: 12px 12px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
    }
    #modalTitle{
      font: 900 14px/1 -apple-system, system-ui, Segoe UI, Roboto, Arial;
      letter-spacing: 0.3px;
      color: rgba(255,255,255,0.92);
      padding-left: 6px;
    }
    #modalClose{
      width: 40px;
      height: 40px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.92);
      cursor:pointer;
    }

    #modalBody{
      flex: 1 1 auto;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      background: rgba(0,0,0,0.15);
    }

    .panel{ display:none; padding: 18px 18px 24px; }
    .panel.on{ display:block; }

    #welcomeFrame{
      width: 100%;
      height: 100%;
      border: 0;
      display:block;
      background: #000;
    }

    /* Mission */
    #missionContent{
      color: rgba(255,255,255,0.88);
      font: 650 14px/1.55 -apple-system, system-ui, Segoe UI, Roboto, Arial;
      max-width: 920px;
      margin: 0 auto;
      padding: 18px 18px 24px;
    }
    #missionContent h2{
      font: 900 18px/1.2 -apple-system, system-ui, Segoe UI, Roboto, Arial;
      margin: 0 0 10px;
      letter-spacing: 0.2px;
    }
    #missionContent p{ margin: 0 0 12px; color: rgba(255,255,255,0.80); }

    /* Stations UI */
    .h1{
      font: 950 20px/1.15 -apple-system, system-ui, Segoe UI, Roboto, Arial;
      letter-spacing: 0.25px;
      margin: 2px 0 8px;
    }
    .sub{
      font: 650 13px/1.35 -apple-system, system-ui, Segoe UI, Roboto, Arial;
      color: rgba(255,255,255,0.72);
      margin: 0 0 14px;
    }
    .input{
      width: 100%;
      padding: 14px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.92);
      outline: none;
      font: 750 14px/1 -apple-system, system-ui, Segoe UI, Roboto, Arial;
      letter-spacing: 0.1px;
    }
    .row{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content: space-between;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.92);
      font: 900 14px/1 -apple-system, system-ui, Segoe UI, Roboto, Arial;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{ background: rgba(120,255,200,0.10); border-color: rgba(120,255,200,0.22); }
    .btn.danger{ background: rgba(255,120,120,0.10); border-color: rgba(255,120,120,0.22); }
    .btn.ghost{ background: rgba(255,255,255,0.04); }
    .btn[disabled]{ opacity:0.55; cursor:not-allowed; }

    .card{
      margin-top: 14px;
      padding: 14px 14px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      box-shadow: 0 16px 50px rgba(0,0,0,0.25);
    }
    .cardTitle{
      font: 950 18px/1.15 -apple-system, system-ui, Segoe UI, Roboto, Arial;
      letter-spacing: 0.2px;
      margin-bottom: 6px;
    }
    .meta{
      font: 700 12px/1.35 -apple-system, system-ui, Segoe UI, Roboto, Arial;
      color: rgba(255,255,255,0.70);
      margin-bottom: 10px;
    }

    /* Role picker */
    #rolePickerMask{
      position: fixed;
      inset: 0;
      z-index: 30000;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    #rolePickerMask.on{ display:flex; }
    #rolePicker{
      width: min(520px, calc(100vw - 24px));
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(12,14,18,0.86);
      box-shadow: 0 20px 70px rgba(0,0,0,0.55);
      overflow: hidden;
    }
    #rolePickerTop{
      padding: 12px 14px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
    }
    #rolePickerTitle{
      font: 900 13px/1.2 -apple-system, system-ui, Segoe UI, Roboto, Arial;
      letter-spacing: 0.25px;
      color: rgba(255,255,255,0.92);
    }
    #rolePickerClose{
      width: 40px; height: 40px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.92);
      cursor:pointer;
    }
    #rolePickerBody{ padding: 14px; }
    .roleGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }
    .roleBtn{
      padding: 14px 14px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.92);
      cursor:pointer;
      text-align:left;
      -webkit-tap-highlight-color: transparent;
    }
    .roleBtn:active{ transform: translateY(1px); }
    .roleName{ font: 950 14px/1 -apple-system, system-ui, Segoe UI, Roboto, Arial; letter-spacing:0.2px; }
    .roleDesc{ margin-top: 6px; font: 650 12px/1.35 -apple-system, system-ui, Segoe UI, Roboto, Arial; color: rgba(255,255,255,0.68); }
    .roleBtn[disabled]{ opacity:0.55; cursor:not-allowed; }

    /* Overlay Library */
    .libRow{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .tiny{
      font: 700 12px/1.35 -apple-system, system-ui, Segoe UI, Roboto, Arial;
      color: rgba(255,255,255,0.72);
    }

    /* Hub (X + Discord feel) */
    .hubWrap{
      display:flex;
      gap: 12px;
      padding: 14px;
      height: calc(86vh - 60px);
      box-sizing:border-box;
    }
    .rail{
      width: 56px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.05);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 10px;
      padding: 10px 8px;
      flex: 0 0 auto;
    }
    .railBtn{
      width: 44px; height: 44px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.92);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font: 900 16px/1 -apple-system, system-ui, Segoe UI, Roboto, Arial;
      -webkit-tap-highlight-color: transparent;
    }
    .railBtn.on{
      border-color: rgba(120,255,200,0.24);
      background: rgba(120,255,200,0.08);
      box-shadow: 0 0 18px rgba(120,255,200,0.12);
    }
    .hubMain{
      flex: 1 1 auto;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.05);
      overflow: hidden;
      display:flex;
      flex-direction:column;
    }
    .hubTopBar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      padding: 12px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
    }
    .hubTitle{
      font: 950 14px/1 -apple-system, system-ui, Segoe UI, Roboto, Arial;
      letter-spacing: 0.25px;
      color: rgba(255,255,255,0.92);
    }
    .hubRole{
      font: 800 12px/1 -apple-system, system-ui, Segoe UI, Roboto, Arial;
      color: rgba(255,255,255,0.68);
    }
    .hubBody{
      padding: 12px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }

    .post{
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.04);
      margin-bottom: 10px;
    }
    .postHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 8px;
      margin-bottom: 8px;
    }
    .who{
      font: 900 12px/1 -apple-system, system-ui, Segoe UI, Roboto, Arial;
      color: rgba(255,255,255,0.88);
    }
    .when{
      font: 700 11px/1 -apple-system, system-ui, Segoe UI, Roboto, Arial;
      color: rgba(255,255,255,0.55);
    }
    .postText{
      font: 650 13px/1.45 -apple-system, system-ui, Segoe UI, Roboto, Arial;
      color: rgba(255,255,255,0.82);
    }
    .actions{
      margin-top: 10px;
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .chip{
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.04);
      font: 900 12px/1 -apple-system, system-ui, Segoe UI, Roboto, Arial;
      color: rgba(255,255,255,0.88);
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .chip:active{ transform: translateY(1px); }

    /* Profile */
    .profileHeader{
      display:flex;
      gap: 12px;
      align-items:center;
      margin-bottom: 14px;
    }
    .avatar{
      width: 56px; height: 56px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      overflow:hidden;
      flex: 0 0 auto;
      display:flex;
      align-items:center;
      justify-content:center;
      color: rgba(255,255,255,0.55);
      font: 900 14px/1 -apple-system, system-ui, Segoe UI, Roboto, Arial;
    }
    .avatar img{ width: 100%; height:100%; object-fit: cover; display:block; }
    .kv{
      display:flex;
      flex-direction:column;
      gap: 6px;
      min-width: 0;
    }
    .kv label{
      font: 800 11px/1 -apple-system, system-ui, Segoe UI, Roboto, Arial;
      color: rgba(255,255,255,0.58);
      letter-spacing: 0.25px;
      text-transform: uppercase;
    }
    .kv input{
      width: min(380px, 100%);
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.92);
      outline: none;
      font: 850 14px/1 -apple-system, system-ui, Segoe UI, Roboto, Arial;
    }
    .toggleRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.04);
      margin: 10px 0 12px;
    }
    .toggleRow .tTitle{
      font: 900 13px/1.2 -apple-system, system-ui, Segoe UI, Roboto, Arial;
      color: rgba(255,255,255,0.88);
    }
    .toggleRow .tSub{
      margin-top: 4px;
      font: 650 12px/1.35 -apple-system, system-ui, Segoe UI, Roboto, Arial;
      color: rgba(255,255,255,0.64);
    }
    .switch{
      width: 54px;
      height: 30px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      position: relative;
      cursor:pointer;
      flex: 0 0 auto;
    }
    .switch::after{
      content:"";
      width: 24px; height: 24px;
      border-radius: 999px;
      position:absolute;
      top: 2px; left: 2px;
      background: rgba(255,255,255,0.22);
      transition: left 180ms ease, background 180ms ease;
    }
    .switch.on{
      border-color: rgba(120,255,200,0.24);
      background: rgba(120,255,200,0.08);
    }
    .switch.on::after{
      left: 28px;
      background: rgba(120,255,200,0.82);
    }

    /* Toast */
    #toast{
      position: fixed;
      left: 50%;
      bottom: 96px;
      transform: translateX(-50%);
      z-index: 40000;
      display:none;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(12,14,18,0.78);
      color: rgba(255,255,255,0.92);
      box-shadow: var(--shadow);
      font: 900 12px/1.2 -apple-system, system-ui, Segoe UI, Roboto, Arial;
      letter-spacing: 0.15px;
      max-width: min(520px, calc(100vw - 32px));
      text-align:center;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }

    @media (max-width: 520px){
      .gridTop{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
      .pill{ padding: 12px 12px; border-radius: 16px; font-size: 13px; }
      #drawerBody{ max-height: calc(100vh - 200px); }
      #subtitle{ max-width: 310px; }
      .pill .hint{ display:none; }
      .hubWrap{ padding: 12px; }
      .rail{ width: 52px; }
      .railBtn{ width: 40px; height: 40px; border-radius: 14px; }
    }
    @media (max-width: 380px){
      .gridTop{ grid-template-columns: 1fr; }
      .roleGrid{ grid-template-columns: 1fr; }
    }
  </style>

  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.161.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.161.0/examples/jsm/"
      }
    }
  </script>
</head>

<body>
  <button id="openBtn" aria-label="Open MAP E.D.E.N.">MAP E.D.E.N.</button>

  <div id="drawer">
    <div id="handle" title="Tap to collapse/expand"></div>

    <div id="drawerTop">
      <div id="titleBlock">
        <div id="title">MAP E.D.E.N.</div>
        <div id="subtitle">Earth Diametric Energy Network ‚Ä¢ Tap Station to begin</div>
      </div>
      <button id="closeBtn" aria-label="Close drawer" title="Close">‚úï</button>
    </div>

    <div id="drawerBody">
      <div class="gridTop">
        <button class="pill" id="welcomeBtn">
          <span class="left"><span class="dot"></span><span class="label">Welcome</span></span>
        </button>

        <button class="pill" id="missionBtn">
          <span class="left"><span class="dot"></span><span class="label">Mission</span></span>
        </button>

        <button class="pill switch" id="stationBtn">
          <span class="left"><span class="dot"></span><span class="label">Station</span></span>
          <span class="hint" id="stationHint">Tap to begin</span>
        </button>
      </div>

      <!-- Station group = default smart controls only -->
      <div id="stationGroup">
        <div class="grid2">
          <button class="pill" id="coreBtn">
            <span class="left"><span class="dot"></span><span class="label">Core</span></span>
          </button>
          <button class="pill" id="stackBtn">
            <span class="left"><span class="dot"></span><span class="label">Stack</span></span>
          </button>

          <button class="pill" id="stationsBtn">
            <span class="left"><span class="dot"></span><span class="label">Stations</span></span>
          </button>
          <button class="pill" id="overlayPlusBtn">
            <span class="left"><span class="dot"></span><span class="label">Overlay +</span></span>
          </button>

          <button class="pill" id="clearBtn">
            <span class="left"><span class="dot"></span><span class="label">Clear</span></span>
          </button>
          <button class="pill" id="profileBtn">
            <span class="left"><span class="dot"></span><span class="label">Profile</span></span>
          </button>
        </div>

        <div id="errors"></div>
      </div>
    </div>

    <div id="statusBar">
      <span id="status">Booting‚Ä¶</span>
      <span id="stationText">Exit 222 ‚Ä¢ Station 1 @ 38¬∞9‚Ä≤39‚Ä≥ N, 79¬∞4‚Ä≤24‚Ä≥ W</span>
    </div>
  </div>

  <!-- Unified modal -->
  <div id="modalMask" role="dialog" aria-modal="true" aria-label="MAP E.D.E.N. Modal">
    <div id="modal">
      <div id="modalTop">
        <div id="modalTitle">PANEL</div>
        <button id="modalClose" aria-label="Close modal">‚úï</button>
      </div>
      <div id="modalBody">
        <!-- Welcome -->
        <div id="welcomePanel" class="panel">
          <iframe id="welcomeFrame" title="MAP E.D.E.N. Welcome" loading="lazy"></iframe>
        </div>

        <!-- Mission -->
        <div id="missionPanel" class="panel">
          <div id="missionContent">
            <h2>MAP E.D.E.N. Mission</h2>
            <p>
              Turn the 42¬∞ / 222¬∞ axis hypothesis into a coordinated, evidence-first experiment by producing sensor datasets
              that are repeatable, controlled, and comparable across stations and time.
            </p>
            <p>
              MAP E.D.E.N. is a private, smart community network (X + Discord, but scientific) where Stations (Hubs) coordinate operators,
              publish datasets, discuss results, and iterate protocols with transparency.
            </p>
            <p>
              This globe is the visual switchboard for overlays ‚Äî while Stations govern access, roles, and collaboration.
            </p>
          </div>
        </div>

        <!-- Overlay Library -->
        <div id="overlayPanel" class="panel">
          <div class="h1">Overlay Library</div>
          <div class="sub">Add or remove overlays from your Station view. (Stations stay separate.)</div>
          <div class="libRow">
            <input id="overlaySearch" class="input" placeholder="Search overlays‚Ä¶" />
            <div class="tiny" id="overlaySummary">‚Äî</div>
          </div>
          <div id="overlayList" class="grid2"></div>
        </div>

        <!-- Stations list -->
        <div id="stationsPanel" class="panel">
          <div class="h1">Stations</div>
          <div class="sub">
            Join only works near your location. Exit222‚Ä¢Station1 (Axis 42/222) is the only active station right now.
            Observers/Analysts/Operators require Owner approval to view the Hub.
          </div>

          <input id="stationSearch" class="input" placeholder="Search stations‚Ä¶" />

          <div class="row">
            <button class="btn primary" id="createStationBtn">+ Create</button>
            <button class="btn danger" id="deleteStationBtn">‚àí Delete</button>
            <button class="btn ghost" id="requestLocationBtn">Enable Location</button>
          </div>

          <div id="stationsList"></div>
        </div>

        <!-- Station preview -->
        <div id="stationPreviewPanel" class="panel">
          <div class="h1" id="previewName">Station</div>
          <div class="sub" id="previewMeta">‚Äî</div>

          <div class="card">
            <div class="meta" id="previewAccess">Access: ‚Äî</div>
            <div class="row">
              <button class="btn primary" id="previewJoinBtn">Join</button>
              <button class="btn" id="previewFollowBtn">Follow</button>
              <button class="btn" id="previewHubBtn">View Hub</button>
            </div>
            <div class="tiny" id="previewNote" style="margin-top:10px; color: rgba(255,255,255,0.62);">
              Join requests require Owner approval. Hub view requires approval.
            </div>
          </div>
        </div>

        <!-- Hub -->
        <div id="hubPanel" class="panel" style="padding:0;">
          <div class="hubWrap">
            <div class="rail" aria-label="Hub rail">
              <button class="railBtn on" data-hubtab="feed" title="Feed">üì∞</button>
              <button class="railBtn" data-hubtab="data" title="Data">üìä</button>
              <button class="railBtn" data-hubtab="chat" title="Chat">üí¨</button>
              <button class="railBtn" data-hubtab="files" title="Files">üìÅ</button>
            </div>

            <div class="hubMain">
              <div class="hubTopBar">
                <div>
                  <div class="hubTitle" id="hubTitle">Hub</div>
                  <div class="hubRole" id="hubRole">Role: ‚Äî</div>
                </div>
                <div class="row" style="margin:0;">
                  <button class="btn ghost" id="hubFollowBtn">Follow</button>
                </div>
              </div>

              <div class="hubBody" id="hubBody"></div>
            </div>
          </div>
        </div>

        <!-- Profile -->
        <div id="profilePanel" class="panel">
          <div class="h1">Profile</div>
          <div class="sub">Minimal, scientific identity + microblog (prototype-local). Stations remain public; profile/research visibility can be private/public.</div>

          <div class="profileHeader">
            <div class="avatar" id="avatarBox">ED</div>
            <div class="kv">
              <label>Display name</label>
              <input id="profileName" placeholder="Enter name‚Ä¶" />
              <div class="tiny" id="roleSymbols" style="margin-top:2px;">Role symbols: ‚¨° Owner ‚Ä¢ ‚õ≠ Operator ‚Ä¢ ‚àë Analyst ‚Ä¢ ‚óâ Observer</div>
            </div>
          </div>

          <div class="row" style="margin-top:0;">
            <input type="file" id="avatarInput" accept="image/*" style="display:none;" />
            <button class="btn" id="avatarUploadBtn">Upload photo</button>
            <button class="btn danger" id="avatarRemoveBtn">Remove</button>
          </div>

          <div class="toggleRow">
            <div>
              <div class="tTitle">Account visibility</div>
              <div class="tSub">Public profiles can be followed. Private profiles require approval to follow.</div>
            </div>
            <div class="switch" id="privacySwitch" role="switch" aria-checked="false"></div>
          </div>

          <div class="card">
            <div class="cardTitle">Micro-post (Field Note)</div>
            <div class="sub" style="margin-bottom:10px;">Post a scientific note. (Local-only prototype)</div>
            <input id="postInput" class="input" placeholder="Write a field note‚Ä¶" />
            <div class="row">
              <button class="btn primary" id="postBtn">Post</button>
              <div class="tiny" id="profileStats">Posts: 0 ‚Ä¢ Likes: 0 ‚Ä¢ Messages: 0</div>
            </div>
          </div>

          <div id="profileFeed" style="margin-top: 14px;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Role picker -->
  <div id="rolePickerMask" aria-label="Role picker">
    <div id="rolePicker">
      <div id="rolePickerTop">
        <div id="rolePickerTitle">Choose role</div>
        <button id="rolePickerClose" aria-label="Close role picker">‚úï</button>
      </div>
      <div id="rolePickerBody">
        <div class="roleGrid">
          <button class="roleBtn" data-role="Observer">
            <div class="roleName">‚óâ Observer</div>
            <div class="roleDesc">View Hub (requires Owner approval).</div>
          </button>
          <button class="roleBtn" data-role="Analyst">
            <div class="roleName">‚àë Analyst</div>
            <div class="roleDesc">Analyze + comment (requires Owner approval).</div>
          </button>
          <button class="roleBtn" data-role="Operator">
            <div class="roleName">‚õ≠ Operator</div>
            <div class="roleDesc">Operate station tasks (requires Owner approval).</div>
          </button>
          <button class="roleBtn" data-role="Owner">
            <div class="roleName">‚¨° Owner</div>
            <div class="roleDesc">Create/manage station (not allowed on stations already owned).</div>
          </button>
        </div>
        <div class="tiny" style="margin-top:12px; color: rgba(255,255,255,0.62);">
          Join requires proximity + Owner approval. Owner role is only allowed when you create a station.
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast"></div>

  <script type="module">
    import * as THREE from "three";
    import { EffectComposer } from "three/addons/postprocessing/EffectComposer.js";
    import { RenderPass } from "three/addons/postprocessing/RenderPass.js";
    import { ShaderPass } from "three/addons/postprocessing/ShaderPass.js";
    import { OutputPass } from "three/addons/postprocessing/OutputPass.js";
    import { UnrealBloomPass } from "three/addons/postprocessing/UnrealBloomPass.js";

    // ============================
    // Elements
    // ============================
    const statusEl   = document.getElementById("status");
    const errorsEl   = document.getElementById("errors");
    const drawerEl   = document.getElementById("drawer");
    const openBtn    = document.getElementById("openBtn");
    const closeBtn   = document.getElementById("closeBtn");
    const handle     = document.getElementById("handle");

    const welcomeBtn = document.getElementById("welcomeBtn");
    const missionBtn = document.getElementById("missionBtn");

    // Station (renamed from Switchboard)
    const stationBtn  = document.getElementById("stationBtn");
    const stationHint = document.getElementById("stationHint");
    const stationGroup= document.getElementById("stationGroup");

    // Station controls
    const coreBtn     = document.getElementById("coreBtn");
    const stackBtn    = document.getElementById("stackBtn");
    const stationsBtn = document.getElementById("stationsBtn");
    const overlayPlusBtn = document.getElementById("overlayPlusBtn");
    const clearBtn    = document.getElementById("clearBtn");
    const profileBtn  = document.getElementById("profileBtn");

    // Modal system
    const modalMask   = document.getElementById("modalMask");
    const modalClose  = document.getElementById("modalClose");
    const modalTitle  = document.getElementById("modalTitle");

    const welcomePanel = document.getElementById("welcomePanel");
    const missionPanel = document.getElementById("missionPanel");
    const overlayPanel = document.getElementById("overlayPanel");
    const stationsPanel= document.getElementById("stationsPanel");
    const stationPreviewPanel = document.getElementById("stationPreviewPanel");
    const hubPanel     = document.getElementById("hubPanel");
    const profilePanel = document.getElementById("profilePanel");

    const welcomeFrame = document.getElementById("welcomeFrame");

    // Overlay library UI
    const overlayList = document.getElementById("overlayList");
    const overlaySearch = document.getElementById("overlaySearch");
    const overlaySummary = document.getElementById("overlaySummary");

    // Stations UI
    const stationSearch = document.getElementById("stationSearch");
    const stationsList = document.getElementById("stationsList");
    const createStationBtn = document.getElementById("createStationBtn");
    const deleteStationBtn = document.getElementById("deleteStationBtn");
    const requestLocationBtn = document.getElementById("requestLocationBtn");

    // Station preview UI
    const previewName = document.getElementById("previewName");
    const previewMeta = document.getElementById("previewMeta");
    const previewAccess = document.getElementById("previewAccess");
    const previewJoinBtn = document.getElementById("previewJoinBtn");
    const previewFollowBtn = document.getElementById("previewFollowBtn");
    const previewHubBtn = document.getElementById("previewHubBtn");
    const previewNote = document.getElementById("previewNote");

    // Hub UI
    const hubTitle = document.getElementById("hubTitle");
    const hubRole = document.getElementById("hubRole");
    const hubBody = document.getElementById("hubBody");
    const hubFollowBtn = document.getElementById("hubFollowBtn");

    // Role picker
    const rolePickerMask = document.getElementById("rolePickerMask");
    const rolePickerClose = document.getElementById("rolePickerClose");
    const rolePickerTitle = document.getElementById("rolePickerTitle");

    // Profile UI
    const avatarBox = document.getElementById("avatarBox");
    const avatarInput = document.getElementById("avatarInput");
    const avatarUploadBtn = document.getElementById("avatarUploadBtn");
    const avatarRemoveBtn = document.getElementById("avatarRemoveBtn");
    const profileName = document.getElementById("profileName");
    const privacySwitch = document.getElementById("privacySwitch");
    const postInput = document.getElementById("postInput");
    const postBtn = document.getElementById("postBtn");
    const profileFeed = document.getElementById("profileFeed");
    const profileStats = document.getElementById("profileStats");

    // Toast
    const toastEl = document.getElementById("toast");

    const stationTextEl = document.getElementById("stationText");

    // ============================
    // Toast
    // ============================
    let toastTimer = 0;
    function toast(msg){
      clearTimeout(toastTimer);
      toastEl.textContent = msg;
      toastEl.style.display = "block";
      toastTimer = setTimeout(()=> toastEl.style.display = "none", 2200);
    }

    // ============================
    // Quiet status system (no red panel for texture fallbacks)
    // ============================
    let statusBase = "Booting‚Ä¶";
    const notices = new Set();

    function renderStatus(){
      if (!statusEl) return;
      if (notices.size){
        const list = Array.from(notices).join(", ");
        statusEl.textContent = `${statusBase} ‚Ä¢ Texture fallback: ${list}`;
      } else {
        statusEl.textContent = statusBase;
      }
    }
    function setStatusBase(s){
      statusBase = s;
      renderStatus();
    }
    function addNotice(n){
      notices.add(n);
      renderStatus();
    }

    // Only REAL errors get the red panel
    function showError(msg){
      if (errorsEl){
        errorsEl.style.display = "block";
        errorsEl.textContent += (errorsEl.textContent ? "\n\n" : "") + msg;
      }
      setStatusBase("Error (see panel)");
    }
    window.addEventListener("error", (e) => showError("JS Error:\n" + (e.message || e.error || e)));
    window.addEventListener("unhandledrejection", (e) => showError("Promise Rejection:\n" + (e.reason?.message || e.reason || e)));

    // ============================
    // Drawer
    // ============================
    function setDrawerClosed(isClosed){
      drawerEl.classList.toggle("closed", !!isClosed);
      openBtn.style.display = isClosed ? "inline-flex" : "none";
    }
    setDrawerClosed(false);
    openBtn.addEventListener("click", () => setDrawerClosed(false));
    closeBtn.addEventListener("click", () => setDrawerClosed(true));
    handle.addEventListener("click", () => drawerEl.classList.toggle("collapsed"));

    // ‚ÄúLights turn green‚Äù for top buttons
    function setTopOn(btn){ btn.classList.add("on"); }

    // ============================
    // Modal routing
    // ============================
    const PANELS = [welcomePanel, missionPanel, overlayPanel, stationsPanel, stationPreviewPanel, hubPanel, profilePanel];

    function showPanel(panel, title){
      PANELS.forEach(p => p.classList.remove("on"));
      panel.classList.add("on");
      modalTitle.textContent = title;
      modalMask.classList.add("on");
    }

    function openWelcome(){
      setTopOn(welcomeBtn);
      showPanel(welcomePanel, "WELCOME");
      const WELCOME_FILE = "assets/welcome6.html";
      const u = new URL(WELCOME_FILE, window.location.href);
      u.searchParams.set("v", Date.now().toString());
      welcomeFrame.style.height = "100%";
      welcomeFrame.src = u.toString();
    }

    function openMission(){
      setTopOn(missionBtn);
      showPanel(missionPanel, "MISSION");
    }

    function openOverlayLibrary(){
      showPanel(overlayPanel, "OVERLAY +");
      renderOverlayLibrary();
    }

    function openStations(){
      showPanel(stationsPanel, "STATIONS");
      renderStations();
    }

    function openStationPreview(st){
      currentPreviewStationId = st.id;
      showPanel(stationPreviewPanel, "STATION PREVIEW");
      renderStationPreview(st);
    }

    function openHub(st){
      showPanel(hubPanel, "VIEW HUB");
      renderHub(st);
    }

    function openProfile(){
      showPanel(profilePanel, "PROFILE");
      renderProfile();
    }

    function closeModal(){
      modalMask.classList.remove("on");
      // clean welcome iframe to reduce memory
      if (welcomePanel.classList.contains("on")){
        welcomeFrame.src = "about:blank";
      }
      PANELS.forEach(p => p.classList.remove("on"));
    }

    modalClose.addEventListener("click", closeModal);
    modalMask.addEventListener("click", (e)=>{ if(e.target === modalMask) closeModal(); });

    welcomeBtn.addEventListener("click", openWelcome);
    missionBtn.addEventListener("click", openMission);

    // ============================
    // Station button toggles the stationGroup
    // ============================
    let stationOn = false;
    function setStation(on){
      stationOn = !!on;
      stationBtn.classList.toggle("on", stationOn);
      stationGroup.classList.toggle("on", stationOn);
      stationHint.textContent = stationOn ? "Tap to close" : "Tap to begin";
    }
    stationBtn.addEventListener("click", ()=> setStation(!stationOn));
    setStation(false);

    // ============================
    // Data (local prototype)
    // ============================
    const LS = {
      profile: "eden_profile_v1",
      overlays: "eden_overlays_v1",
      stations: "eden_stations_v1",
      follows: "eden_follows_v1",
      access: "eden_access_v1",
      posts: "eden_posts_v1"
    };

    const ROLE_SYMBOL = {
      Owner: "‚¨°",
      Operator: "‚õ≠",
      Analyst: "‚àë",
      Observer: "‚óâ"
    };

    function loadJSON(key, fallback){
      try{
        const v = localStorage.getItem(key);
        return v ? JSON.parse(v) : fallback;
      } catch { return fallback; }
    }
    function saveJSON(key, val){
      localStorage.setItem(key, JSON.stringify(val));
    }

    function nowISO(){
      return new Date().toISOString();
    }

    // Default profile
    let profile = loadJSON(LS.profile, {
      name: "E.D.E.N. User",
      isPublic: true,
      avatar: null,
      stats: { likes: 0, messages: 0 }
    });

    // Station inventory (prototype)
    const ANCHOR = { id:"exit222_station1", name:"Exit222‚Ä¢Station1", axis:"42/222", lat: 38.1608333333, lon: -79.0733333333 };
    let stations = loadJSON(LS.stations, [
      {
        id: ANCHOR.id,
        name: ANCHOR.name,
        axis: "42/222",
        lat: ANCHOR.lat,
        lon: ANCHOR.lon,
        ownerId: "system_owner",
        ownerName: "Owner",
        joinRadiusKm: 100,
        isActive: true,
        requireApproval: true
      }
    ]);

    // Follows + Access state (prototype)
    // follows: { [stationId]: true/false }
    let follows = loadJSON(LS.follows, {});
    // access: { [stationId]: { status:"none"|"pending"|"approved", role: "Observer"|"Analyst"|"Operator"|"Owner" } }
    let access = loadJSON(LS.access, {});

    // Overlay state (what is visible)
    // Note: stations overlay stays separate & always allowed
    const DEFAULT_STATE = {
      rhumb222: true,
      rhumb42:  false,
      gc222:    true,
      gc42:     false,
      names222: false,
      names42:  false,
      perpLine: false,
      perpName: false,
      continents:false,
      stations: true,
      corridors:false,
      magField: false,
      aurora:   false,
      nightLights: true
    };
    let overlayState = loadJSON(LS.overlays, {...DEFAULT_STATE});
    // Always enforce stations on (separate)
    overlayState.stations = true;

    // Overlay library list (restored fully)
    const OVERLAY_LIBRARY = [
      { key:"rhumb222",   label:"Rhumb 222 SW" },
      { key:"rhumb42",    label:"Rhumb 42 NE" },
      { key:"gc222",      label:"Great Circle 222 SW" },
      { key:"gc42",       label:"Great Circle 42 NE" },
      { key:"names222",   label:"Names 222 SW" },
      { key:"names42",    label:"Names 42 NE" },
      { key:"perpLine",   label:"Perpendiculars" },
      { key:"continents", label:"Continents" },
      { key:"corridors",  label:"Corridors" },
      { key:"magField",   label:"Magnetic Field" },
      { key:"aurora",     label:"Aurora" },
      { key:"nightLights",label:"Night Lights" },
      { key:"perpName",   label:"Perp Name" }
    ];

    // Presets
    const PRESET_CORE = (s)=>({
      ...s,
      rhumb222: true,
      gc222: true,
      nightLights: true,
      corridors: false,
      rhumb42: false,
      gc42: false,
      names222: false,
      names42: false,
      perpLine: false,
      perpName: false,
      continents: false,
      magField: false,
      aurora: false,
      stations: true
    });

    const PRESET_STACK = (s)=>({
      ...s,
      rhumb222: true,
      rhumb42: true,
      gc222: true,
      gc42: true,
      names222: true,
      names42: true,
      perpLine: true,
      perpName: true,
      continents: true,
      corridors: true,
      magField: true,
      aurora: true,
      nightLights: true,
      stations: true
    });

    function applyOverlayState(next){
      overlayState = { ...overlayState, ...next };
      overlayState.stations = true; // lock
      saveJSON(LS.overlays, overlayState);
      applyVisibility();
      syncStationButtons();
    }

    // ============================
    // Profile rendering
    // ============================
    function renderProfile(){
      // avatar
      if (profile.avatar){
        avatarBox.innerHTML = `<img alt="avatar" src="${profile.avatar}">`;
      } else {
        avatarBox.textContent = "ED";
      }
      profileName.value = profile.name || "";
      privacySwitch.classList.toggle("on", !!profile.isPublic);
      privacySwitch.setAttribute("aria-checked", profile.isPublic ? "true" : "false");

      // posts
      const posts = loadJSON(LS.posts, []);
      const likes = profile.stats?.likes ?? 0;
      const messages = profile.stats?.messages ?? 0;
      profileStats.textContent = `Posts: ${posts.length} ‚Ä¢ Likes: ${likes} ‚Ä¢ Messages: ${messages}`;

      profileFeed.innerHTML = "";
      posts.slice().reverse().forEach(p=>{
        const el = document.createElement("div");
        el.className = "post";
        el.innerHTML = `
          <div class="postHead">
            <div class="who">${escapeHTML(profile.name || "E.D.E.N. User")}</div>
            <div class="when">${new Date(p.ts).toLocaleString()}</div>
          </div>
          <div class="postText">${escapeHTML(p.text)}</div>
          <div class="actions">
            <div class="chip" data-like="${p.id}">üëç ${p.likes||0}</div>
            <div class="chip" data-dislike="${p.id}">üëé ${p.dislikes||0}</div>
            <div class="chip" data-love="${p.id}">‚ù§Ô∏è ${p.loves||0}</div>
            <div class="chip" data-comment="${p.id}">üí¨ ${p.comments||0}</div>
          </div>
        `;
        profileFeed.appendChild(el);
      });
    }

    function escapeHTML(s){
      return (s||"").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    privacySwitch.addEventListener("click", ()=>{
      profile.isPublic = !profile.isPublic;
      saveJSON(LS.profile, profile);
      renderProfile();
      toast(profile.isPublic ? "Profile set to Public" : "Profile set to Private");
    });

    avatarUploadBtn.addEventListener("click", ()=> avatarInput.click());
    avatarInput.addEventListener("change", ()=>{
      const f = avatarInput.files?.[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        profile.avatar = String(reader.result || "");
        saveJSON(LS.profile, profile);
        renderProfile();
        toast("Profile photo updated");
      };
      reader.readAsDataURL(f);
    });
    avatarRemoveBtn.addEventListener("click", ()=>{
      profile.avatar = null;
      saveJSON(LS.profile, profile);
      renderProfile();
      toast("Profile photo removed");
    });
    profileName.addEventListener("input", ()=>{
      profile.name = profileName.value.slice(0, 40);
      saveJSON(LS.profile, profile);
    });

    postBtn.addEventListener("click", ()=>{
      const txt = (postInput.value || "").trim();
      if (!txt) return toast("Write a field note first");
      const posts = loadJSON(LS.posts, []);
      posts.push({ id: cryptoRandomId(), ts: nowISO(), text: txt, likes:0, dislikes:0, loves:0, comments:0 });
      saveJSON(LS.posts, posts);
      postInput.value = "";
      renderProfile();
      toast("Posted");
    });

    profileFeed.addEventListener("click", (e)=>{
      const t = e.target;
      const posts = loadJSON(LS.posts, []);
      const upd = (id, fn)=>{
        const p = posts.find(x=>x.id===id);
        if (!p) return;
        fn(p);
        saveJSON(LS.posts, posts);
        renderProfile();
      };
      if (t?.dataset?.like){
        upd(t.dataset.like, p=>{ p.likes=(p.likes||0)+1; profile.stats.likes=(profile.stats.likes||0)+1; saveJSON(LS.profile, profile); });
      }
      if (t?.dataset?.dislike){
        upd(t.dataset.dislike, p=>{ p.dislikes=(p.dislikes||0)+1; });
      }
      if (t?.dataset?.love){
        upd(t.dataset.love, p=>{ p.loves=(p.loves||0)+1; });
      }
      if (t?.dataset?.comment){
        upd(t.dataset.comment, p=>{ p.comments=(p.comments||0)+1; });
      }
    });

    function cryptoRandomId(){
      try{
        return crypto.getRandomValues(new Uint32Array(2)).join("-");
      } catch {
        return String(Math.random()).slice(2) + "-" + Date.now();
      }
    }

    // ============================
    // Overlay Library UI
    // ============================
    function renderOverlayLibrary(){
      const q = (overlaySearch.value || "").trim().toLowerCase();
      overlayList.innerHTML = "";

      const filtered = OVERLAY_LIBRARY.filter(o => o.label.toLowerCase().includes(q));
      filtered.forEach(o=>{
        const b = document.createElement("button");
        b.className = "pill";
        b.dataset.key = o.key;
        b.innerHTML = `<span class="left"><span class="dot"></span><span class="label">${o.label}</span></span><span class="hint">${overlayState[o.key] ? "Overlay ‚àí" : "Overlay +"}</span>`;
        b.classList.toggle("on", !!overlayState[o.key]);
        b.addEventListener("click", ()=>{
          // Toggle overlay
          overlayState[o.key] = !overlayState[o.key];
          saveJSON(LS.overlays, overlayState);
          applyVisibility();
          renderOverlayLibrary();
          toast(overlayState[o.key] ? `${o.label} added` : `${o.label} removed`);
        });
        overlayList.appendChild(b);
      });

      const onCount = OVERLAY_LIBRARY.reduce((n,o)=> n + (overlayState[o.key] ? 1 : 0), 0);
      overlaySummary.textContent = `Active overlays: ${onCount}/${OVERLAY_LIBRARY.length}`;
    }

    overlaySearch.addEventListener("input", renderOverlayLibrary);

    // ============================
    // Location + Stations
    // ============================
    let userLoc = loadJSON("eden_user_loc_v1", null); // {lat,lon,ts}
    function haversineKm(lat1, lon1, lat2, lon2){
      const R = 6371;
      const toRad = (d)=> d*Math.PI/180;
      const dLat = toRad(lat2-lat1);
      const dLon = toRad(lon2-lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.min(1, Math.sqrt(a)));
    }

    async function requestLocation(){
      return new Promise((resolve)=>{
        if (!navigator.geolocation){
          toast("Geolocation not supported");
          return resolve(null);
        }
        navigator.geolocation.getCurrentPosition((pos)=>{
          userLoc = { lat: pos.coords.latitude, lon: pos.coords.longitude, ts: Date.now() };
          saveJSON("eden_user_loc_v1", userLoc);
          toast("Location enabled");
          resolve(userLoc);
        }, ()=>{
          toast("Location denied ‚Äî Join is blocked");
          resolve(null);
        }, { enableHighAccuracy: true, timeout: 9000, maximumAge: 60_000 });
      });
    }

    requestLocationBtn.addEventListener("click", async ()=>{
      await requestLocation();
      renderStations();
    });

    function stationDistanceText(st){
      if (!userLoc) return "Distance: ‚Äî (enable location to join)";
      const km = haversineKm(userLoc.lat, userLoc.lon, st.lat, st.lon);
      return `${km.toFixed(1)} km away ‚Ä¢ Join/View radius ${st.joinRadiusKm} km`;
    }

    function canJoinByLocation(st){
      if (!userLoc) return false;
      const km = haversineKm(userLoc.lat, userLoc.lon, st.lat, st.lon);
      return km <= (st.joinRadiusKm || 100);
    }

    function getAccess(stId){
      return access[stId] || { status:"none", role:null };
    }

    function renderStations(){
      const q = (stationSearch.value || "").trim().toLowerCase();
      stationsList.innerHTML = "";

      const list = stations.filter(s => s.name.toLowerCase().includes(q));
      list.forEach(st=>{
        const kmTxt = stationDistanceText(st);

        const card = document.createElement("div");
        card.className = "card";
        const acc = getAccess(st.id);
        const follow = !!follows[st.id];

        card.innerHTML = `
          <div class="cardTitle">${escapeHTML(st.name)}</div>
          <div class="meta">Axis ${escapeHTML(st.axis)} ‚Ä¢ ${fmtDMS(st.lat, st.lon)}</div>
          <div class="meta">${escapeHTML(kmTxt)}</div>
          <div class="meta">Access: ${acc.status === "approved" ? "Approved" : (acc.status === "pending" ? "Pending" : "None")}${acc.role ? " ‚Ä¢ " + acc.role : ""}</div>
          <div class="row">
            <button class="btn primary" data-open="${st.id}">Preview</button>
            <button class="btn" data-follow="${st.id}">${follow ? "Unfollow" : "Follow"}</button>
          </div>
        `;
        stationsList.appendChild(card);
      });
    }

    stationSearch.addEventListener("input", renderStations);

    stationsList.addEventListener("click", (e)=>{
      const t = e.target;
      const openId = t?.dataset?.open;
      const followId = t?.dataset?.follow;

      if (openId){
        const st = stations.find(s=>s.id===openId);
        if (st) openStationPreview(st);
      }
      if (followId){
        follows[followId] = !follows[followId];
        saveJSON(LS.follows, follows);
        toast(follows[followId] ? "Station followed" : "Station unfollowed");
        renderStations();
      }
    });

    // Create/Delete station (prototype-local)
    createStationBtn.addEventListener("click", ()=>{
      const name = prompt("Name your Station (Owner creates):", "NewStation‚Ä¢001");
      if (!name) return;
      const s = {
        id: "st_" + cryptoRandomId(),
        name: name.trim().slice(0, 40),
        axis: "42/222",
        lat: (userLoc?.lat ?? ANCHOR.lat),
        lon: (userLoc?.lon ?? ANCHOR.lon),
        ownerId: "me",
        ownerName: profile.name || "Owner",
        joinRadiusKm: 100,
        isActive: true,
        requireApproval: true
      };
      stations.push(s);
      saveJSON(LS.stations, stations);

      // Owner gets approved access automatically
      access[s.id] = { status:"approved", role:"Owner" };
      saveJSON(LS.access, access);

      toast("Station created");
      renderStations();
    });

    deleteStationBtn.addEventListener("click", ()=>{
      const name = prompt("Type Station ID to delete (Owner only):");
      if (!name) return;
      const idx = stations.findIndex(s=>s.id===name.trim());
      if (idx < 0) return toast("Station not found");
      const st = stations[idx];
      const acc = getAccess(st.id);
      if (acc.role !== "Owner" || acc.status !== "approved"){
        return toast("Only an approved Owner can delete");
      }
      stations.splice(idx, 1);
      saveJSON(LS.stations, stations);
      delete access[st.id];
      saveJSON(LS.access, access);
      toast("Station deleted");
      renderStations();
    });

    // ============================
    // Station Preview + permissions
    // ============================
    let currentPreviewStationId = null;

    function fmtDMS(lat, lon){
      const dms = (deg, pos, neg)=>{
        const a = Math.abs(deg);
        const d = Math.floor(a);
        const mFloat = (a - d) * 60;
        const m = Math.floor(mFloat);
        const s = Math.round((mFloat - m) * 60);
        return `${d}¬∞${m}‚Ä≤${s}‚Ä≥ ${deg>=0 ? pos : neg}`;
      };
      return `${dms(lat,"N","S")}, ${dms(lon,"E","W")}`;
    }

    function renderStationPreview(st){
      previewName.textContent = st.name;
      previewMeta.textContent = `Axis ${st.axis} ‚Ä¢ ${fmtDMS(st.lat, st.lon)} ‚Ä¢ Join radius ${st.joinRadiusKm} km`;

      const acc = getAccess(st.id);
      const follow = !!follows[st.id];

      previewAccess.textContent = `Access: ${
        acc.status === "approved" ? "Approved" :
        acc.status === "pending" ? "Pending approval" : "None"
      }${acc.role ? " ‚Ä¢ " + acc.role : ""}`;

      previewFollowBtn.textContent = follow ? "Unfollow" : "Follow";

      // Join gating
      const near = canJoinByLocation(st);
      const locOk = !!userLoc;

      previewJoinBtn.disabled = !near;
      if (!locOk){
        previewNote.textContent = "Location is required to Join. Enable Location in Stations.";
      } else if (!near){
        previewNote.textContent = "Join is blocked: you are outside the station radius.";
      } else {
        previewNote.textContent = "Join will request Owner approval (Observer/Analyst/Operator). Owner role is only for station creators.";
      }

      // Hub gating (Observers/Analysts must be approved to view; same for Operator)
      const canViewHub = (acc.status === "approved");
      previewHubBtn.disabled = !canViewHub;
    }

    previewFollowBtn.addEventListener("click", ()=>{
      const st = stations.find(s=>s.id===currentPreviewStationId);
      if (!st) return;
      follows[st.id] = !follows[st.id];
      saveJSON(LS.follows, follows);
      toast(follows[st.id] ? "Station followed" : "Station unfollowed");
      renderStationPreview(st);
    });

    previewJoinBtn.addEventListener("click", ()=>{
      const st = stations.find(s=>s.id===currentPreviewStationId);
      if (!st) return;

      if (!userLoc) return toast("Enable location to Join");
      if (!canJoinByLocation(st)) return toast("Outside Join radius");

      openRolePicker(st);
    });

    previewHubBtn.addEventListener("click", ()=>{
      const st = stations.find(s=>s.id===currentPreviewStationId);
      if (!st) return;
      const acc = getAccess(st.id);
      if (acc.status !== "approved"){
        return toast("Hub access requires approval");
      }
      openHub(st);
    });

    // ============================
    // Role Picker
    // ============================
    let rolePickerStationId = null;

    function openRolePicker(st){
      rolePickerStationId = st.id;
      rolePickerTitle.textContent = `Choose role for ${st.name}`;

      // Disable Owner role if station already has an owner (system or someone else)
      const ownerExists = !!st.ownerId;
      document.querySelectorAll(".roleBtn").forEach(btn=>{
        const role = btn.dataset.role;
        btn.disabled = false;
        if (role === "Owner" && ownerExists && st.ownerId !== "me"){
          btn.disabled = true;
        }
      });

      rolePickerMask.classList.add("on");
    }
    function closeRolePicker(){
      rolePickerMask.classList.remove("on");
      rolePickerStationId = null;
    }
    rolePickerClose.addEventListener("click", closeRolePicker);
    rolePickerMask.addEventListener("click", (e)=>{ if (e.target === rolePickerMask) closeRolePicker(); });

    rolePickerMask.addEventListener("click", (e)=>{
      const btn = e.target.closest?.(".roleBtn");
      if (!btn || btn.disabled) return;
      const role = btn.dataset.role;
      const st = stations.find(s=>s.id===rolePickerStationId);
      if (!st) return;

      // Enforce role rules:
      // - Only Observer/Analyst/Operator/Owner exist (already)
      // - If station owned already, Owner role blocked unless you created it
      if (role === "Owner" && st.ownerId && st.ownerId !== "me"){
        toast("Owner role not allowed on an already-owned station");
        return;
      }

      // Apply request
      if (role === "Owner"){
        access[st.id] = { status:"approved", role:"Owner" };
        st.ownerId = "me";
        st.ownerName = profile.name || "Owner";
        saveJSON(LS.stations, stations);
        toast("You are now Owner (local prototype)");
      } else {
        // requires approval
        access[st.id] = { status:"pending", role };
        toast(`${role} request sent (Pending approval)`);
      }
      saveJSON(LS.access, access);

      closeRolePicker();
      renderStationPreview(st);
    });

    // ============================
    // Hub
    // ============================
    function hubTabButton(tab){
      return document.querySelector(`.railBtn[data-hubtab="${tab}"]`);
    }

    function setHubTab(tab){
      document.querySelectorAll(".railBtn").forEach(b=> b.classList.toggle("on", b.dataset.hubtab === tab));
      renderHubTab(tab);
    }

    function renderHub(st){
      const acc = getAccess(st.id);
      // Observers need permission to view (enforced by requiring approved access)
      if (acc.status !== "approved"){
        hubBody.innerHTML = `<div class="post"><div class="who">Access required</div><div class="postText">Your request is not approved yet.</div></div>`;
        return;
      }

      hubTitle.textContent = `${st.name} ‚Ä¢ Hub`;
      hubRole.textContent = `Role: ${ROLE_SYMBOL[acc.role] || ""} ${acc.role || "‚Äî"} ‚Ä¢ Axis ${st.axis}`;

      const follow = !!follows[st.id];
      hubFollowBtn.textContent = follow ? "Unfollow" : "Follow";

      // Default tab
      setHubTab("feed");
    }

    hubFollowBtn.addEventListener("click", ()=>{
      const st = stations.find(s=>s.id===currentPreviewStationId) || stations.find(s=>s.id===rolePickerStationId);
      // If opened from preview, currentPreviewStationId is set; if not, infer by hubTitle match
      const st2 = stations.find(s=> hubTitle.textContent.startsWith(s.name));
      const use = st2 || st;
      if (!use) return;

      follows[use.id] = !follows[use.id];
      saveJSON(LS.follows, follows);
      toast(follows[use.id] ? "Station followed" : "Station unfollowed");
      hubFollowBtn.textContent = follows[use.id] ? "Unfollow" : "Follow";
    });

    document.querySelectorAll(".railBtn").forEach(b=>{
      b.addEventListener("click", ()=> setHubTab(b.dataset.hubtab));
    });

    function renderHubTab(tab){
      // Minimal scientific content placeholders
      if (tab === "feed"){
        hubBody.innerHTML = `
          <div class="post">
            <div class="postHead"><div class="who">Station Broadcast</div><div class="when">${new Date().toLocaleString()}</div></div>
            <div class="postText">Protocol note: keep exports UTC-tagged. Avoid phone movement during magnetometer capture.</div>
            <div class="actions">
              <div class="chip">üëç</div><div class="chip">üëé</div><div class="chip">‚ù§Ô∏è</div><div class="chip">üí¨</div>
            </div>
          </div>
          <div class="post">
            <div class="postHead"><div class="who">Data Thread</div><div class="when">‚Äî</div></div>
            <div class="postText">Next: add station-to-station comparisons along 42/222. (Hub ‚Üí Data)</div>
          </div>
        `;
      }
      if (tab === "data"){
        hubBody.innerHTML = `
          <div class="post">
            <div class="postHead"><div class="who">Datasets</div><div class="when">UTC</div></div>
            <div class="postText">‚Ä¢ Magnetometer (XYZ) exports<br>‚Ä¢ GNSS UTC snapshots<br>‚Ä¢ Environmental notes (weather, exposure)</div>
          </div>
          <div class="post">
            <div class="postHead"><div class="who">Analysis</div><div class="when">‚Äî</div></div>
            <div class="postText">Compare: step-shifts across X/Y/Z, correlation with device orientation, and local magnetic interference controls.</div>
          </div>
        `;
      }
      if (tab === "chat"){
        hubBody.innerHTML = `
          <div class="post">
            <div class="postHead"><div class="who">Chat</div><div class="when">Channels</div></div>
            <div class="postText">#ops ‚Ä¢ #analysis ‚Ä¢ #field-notes ‚Ä¢ #hardware</div>
          </div>
          <div class="post">
            <div class="postHead"><div class="who">Message</div><div class="when">‚Äî</div></div>
            <div class="postText">This is a prototype UI shell (local). Next step is backend + auth + station permissions.</div>
          </div>
        `;
      }
      if (tab === "files"){
        hubBody.innerHTML = `
          <div class="post">
            <div class="postHead"><div class="who">Files</div><div class="when">Uploads</div></div>
            <div class="postText">‚Ä¢ field_export.csv<br>‚Ä¢ station_notes.md<br>‚Ä¢ image_capture.png<br>‚Ä¢ audio_note.m4a</div>
          </div>
        `;
      }
    }

    // ============================
    // Station control buttons (Core / Stack / Stations / Overlay+ / Profile / Clear)
    // ============================
    function syncStationButtons(){
      // visually light these only as quick feedback (not required)
      coreBtn.classList.toggle("on", isCoreActive());
      stackBtn.classList.toggle("on", isStackActive());
      stationsBtn.classList.toggle("on", true);
      overlayPlusBtn.classList.toggle("on", false);
      profileBtn.classList.toggle("on", false);
      clearBtn.classList.toggle("on", isClearState());
    }

    function isCoreActive(){
      // simple heuristic: core key set matches core preset for a few keys
      return overlayState.rhumb222 && overlayState.gc222 && overlayState.nightLights &&
             !overlayState.rhumb42 && !overlayState.gc42 && !overlayState.corridors &&
             !overlayState.magField && !overlayState.aurora && overlayState.stations;
    }
    function isStackActive(){
      const keys = ["rhumb222","rhumb42","gc222","gc42","names222","names42","perpLine","perpName","continents","corridors","magField","aurora","nightLights"];
      return keys.every(k => !!overlayState[k]) && overlayState.stations;
    }
    function isClearState(){
      const anyOn = OVERLAY_LIBRARY.some(o => o.key !== "stations" && overlayState[o.key]);
      return !anyOn && overlayState.stations;
    }

    coreBtn.addEventListener("click", ()=>{
      applyOverlayState(PRESET_CORE(overlayState));
      toast("Core applied");
    });

    stackBtn.addEventListener("click", ()=>{
      applyOverlayState(PRESET_STACK(overlayState));
      toast("Stack applied");
    });

    clearBtn.addEventListener("click", ()=>{
      const next = {...overlayState};
      OVERLAY_LIBRARY.forEach(o => next[o.key] = false);
      next.stations = true;
      applyOverlayState(next);
      toast("Cleared overlays (Stations kept)");
    });

    stationsBtn.addEventListener("click", ()=>{
      openStations();
    });

    overlayPlusBtn.addEventListener("click", ()=>{
      openOverlayLibrary();
    });

    profileBtn.addEventListener("click", ()=>{
      openProfile();
    });

    // ============================
    // Helper: UI event targets
    // ============================
    function isUIEventTarget(target){
      return !!(target && (target.closest?.("#drawer") || target.closest?.("#openBtn") || target.closest?.("#modalMask") || target.closest?.("#rolePickerMask")));
    }

    // ============================
    // Globe math helpers
    // ============================
    const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
    const DEG = Math.PI/180;
    const RAD = 180/Math.PI;

    function latLonToVec3(latDeg, lonDeg, radius=1.0){
      const lat = latDeg * DEG;
      const lon = lonDeg * DEG;
      return new THREE.Vector3(
        radius * Math.cos(lat) * Math.cos(lon),
        radius * Math.sin(lat),
        radius * Math.cos(lat) * Math.sin(lon)
      );
    }

    function greatCirclePoints(lat0Deg, lon0Deg, bearingDeg, stepDeg=1.0){
      const lat0 = lat0Deg * DEG;
      const lon0 = lon0Deg * DEG;
      const brng = bearingDeg * DEG;

      const pts = [];
      for(let d=-180; d<=180; d+=stepDeg){
        const Œ¥ = d * DEG;
        const sinLat = Math.sin(lat0)*Math.cos(Œ¥) + Math.cos(lat0)*Math.sin(Œ¥)*Math.cos(brng);
        const lat = Math.asin(clamp(sinLat, -1, 1));
        const y = Math.sin(brng)*Math.sin(Œ¥)*Math.cos(lat0);
        const x = Math.cos(Œ¥) - Math.sin(lat0)*Math.sin(lat);
        const lon = lon0 + Math.atan2(y, x);
        pts.push({ lat: lat*RAD, lon: ((lon*RAD + 540) % 360) - 180 });
      }
      return pts;
    }

    function rhumbPoints(lat0Deg, lon0Deg, bearingDeg, stepKm=240){
      const R=6371;
      const œÜ1=lat0Deg*DEG;
      const Œª1=lon0Deg*DEG;
      const Œ∏=bearingDeg*DEG;

      const pts=[];
      const maxSteps=120;
      for (const dir of [-1,+1]){
        let œÜ=œÜ1, Œª=Œª1;
        for (let i=0;i<maxSteps;i++){
          const d = dir*(stepKm/R);
          const ŒîœÜ = d*Math.cos(Œ∏);
          let œÜ2 = clamp(œÜ+ŒîœÜ, -Math.PI/2+1e-6, Math.PI/2-1e-6);

          const Œîœà = Math.log(Math.tan(Math.PI/4+œÜ2/2)/Math.tan(Math.PI/4+œÜ/2));
          const q = Math.abs(Œîœà)>1e-12 ? (ŒîœÜ/Œîœà) : Math.cos(œÜ);

          const ŒîŒª = d*Math.sin(Œ∏)/q;
          let Œª2 = ((Œª+ŒîŒª+Math.PI)%(2*Math.PI))-Math.PI;

          pts.push({ lat: œÜ2*RAD, lon: Œª2*RAD });
          œÜ=œÜ2; Œª=Œª2;
        }
      }
      return pts;
    }

    function makeGlowTube(pointsVec3, radius, coreColor, haloColor, coreOpacity=1.0, haloOpacity=0.28){
      if (!pointsVec3 || pointsVec3.length < 4) return new THREE.Group();
      const curve = new THREE.CatmullRomCurve3(pointsVec3, false, "catmullrom", 0.15);
      const segs = Math.max(320, pointsVec3.length*2);

      const coreGeom = new THREE.TubeGeometry(curve, segs, radius, 10, false);
      const haloGeom = new THREE.TubeGeometry(curve, segs, radius*2.6, 10, false);

      const coreMat = new THREE.MeshBasicMaterial({ color: coreColor, transparent: coreOpacity<1, opacity: coreOpacity, depthWrite:false });
      const haloMat = new THREE.MeshBasicMaterial({ color: haloColor, transparent:true, opacity: haloOpacity, blending: THREE.AdditiveBlending, depthWrite:false });

      const g = new THREE.Group();
      g.add(new THREE.Mesh(haloGeom, haloMat));
      g.add(new THREE.Mesh(coreGeom, coreMat));
      return g;
    }

    function makeTextSprite(text, {
      fontSize=22,
      color="rgba(255,255,255,0.92)",
      glow="rgba(255,255,255,0.16)",
      glowBlur=5,
      padding=8,
      scale=0.0048
    } = {}){
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");

      ctx.font = `900 ${fontSize}px -apple-system, system-ui, Segoe UI, Roboto, Arial`;
      const m = ctx.measureText(text);
      const w = Math.ceil(m.width + padding*2);
      const h = Math.ceil(fontSize + padding*2);

      canvas.width = w; canvas.height = h;

      ctx.font = `900 ${fontSize}px -apple-system, system-ui, Segoe UI, Roboto, Arial`;
      ctx.textBaseline = "middle";
      ctx.textAlign = "left";
      ctx.shadowColor = glow;
      ctx.shadowBlur = glowBlur;
      ctx.fillStyle = color;
      ctx.fillText(text, padding, h/2);

      const tex = new THREE.CanvasTexture(canvas);
      tex.colorSpace = THREE.SRGBColorSpace;
      tex.minFilter = THREE.LinearFilter;
      tex.magFilter = THREE.LinearFilter;

      const mat = new THREE.SpriteMaterial({ map: tex, transparent:true, depthWrite:false, opacity: 1.0 });
      const spr = new THREE.Sprite(mat);
      spr.scale.set(w*scale, h*scale, 1);
      return spr;
    }

    function solidTexture(hex="#222"){
      const c=document.createElement("canvas");
      c.width=2; c.height=2;
      const ctx=c.getContext("2d");
      ctx.fillStyle=hex; ctx.fillRect(0,0,2,2);
      const t=new THREE.CanvasTexture(c);
      t.colorSpace=THREE.SRGBColorSpace;
      return t;
    }

    function makeFallbackStars(){
      const c=document.createElement("canvas");
      c.width=1024; c.height=1024;
      const ctx=c.getContext("2d");
      ctx.fillStyle="#000"; ctx.fillRect(0,0,c.width,c.height);
      for(let i=0;i<2400;i++){
        const x=Math.random()*c.width, y=Math.random()*c.height;
        const a=0.2+Math.random()*0.8;
        const s=Math.random()>0.995?2:1;
        ctx.fillStyle=`rgba(255,255,255,${a})`;
        ctx.fillRect(x,y,s,s);
      }
      const t=new THREE.CanvasTexture(c);
      t.colorSpace=THREE.SRGBColorSpace;
      return t;
    }

    function makeFallbackEarthDay(){
      const c=document.createElement("canvas");
      c.width=1024; c.height=512;
      const ctx=c.getContext("2d");
      ctx.fillStyle="#0c1c3a"; ctx.fillRect(0,0,c.width,c.height);
      ctx.globalAlpha=0.85; ctx.fillStyle="#2b7a4b";
      for(let i=0;i<35;i++){
        const x=Math.random()*c.width, y=Math.random()*c.height;
        const r=20+Math.random()*90;
        ctx.beginPath(); ctx.ellipse(x,y,r,r*0.65,Math.random()*Math.PI,0,Math.PI*2); ctx.fill();
      }
      ctx.globalAlpha=0.14; ctx.fillStyle="#fff";
      for(let i=0;i<80;i++){
        const x=Math.random()*c.width, y=Math.random()*c.height;
        const r=20+Math.random()*100;
        ctx.beginPath(); ctx.ellipse(x,y,r,r*0.45,0,0,Math.PI*2); ctx.fill();
      }
      const t=new THREE.CanvasTexture(c);
      t.colorSpace=THREE.SRGBColorSpace;
      return t;
    }

    function makeFallbackNight(){
      const c=document.createElement("canvas");
      c.width=1024; c.height=512;
      const ctx=c.getContext("2d");
      ctx.fillStyle="#000"; ctx.fillRect(0,0,c.width,c.height);
      ctx.fillStyle="rgba(255,210,120,0.9)";
      for(let i=0;i<2400;i++){
        const x=Math.random()*c.width, y=Math.random()*c.height;
        if(Math.random()<0.985) continue;
        ctx.fillRect(x,y,1,1);
      }
      const t=new THREE.CanvasTexture(c);
      t.colorSpace=THREE.SRGBColorSpace;
      return t;
    }

    function makeFallbackClouds(){
      const c=document.createElement("canvas");
      c.width=1024; c.height=512;
      const ctx=c.getContext("2d");
      ctx.clearRect(0,0,c.width,c.height);
      ctx.fillStyle="rgba(255,255,255,0.40)";
      for(let i=0;i<140;i++){
        const x=Math.random()*c.width, y=Math.random()*c.height;
        const r=30+Math.random()*120;
        ctx.beginPath(); ctx.ellipse(x,y,r,r*0.5,0,0,Math.PI*2); ctx.fill();
      }
      const t=new THREE.CanvasTexture(c);
      t.colorSpace=THREE.SRGBColorSpace;
      return t;
    }

    async function loadTextureWithFallback(urls, fallbackTex, label){
      const loader = new THREE.TextureLoader();
      loader.setCrossOrigin("anonymous");
      const tryOne = (url) => new Promise((resolve, reject) => {
        loader.load(url, resolve, undefined, () => reject(new Error("failed: " + url)));
      });

      for (const u of urls){
        try{
          const tex = await tryOne(u);
          tex.colorSpace = THREE.SRGBColorSpace;
          return tex;
        } catch { /* try next */ }
      }

      addNotice(label);
      return fallbackTex;
    }

    // ============================
    // THREE scene setup (unchanged visuals)
    // ============================
    let renderer, camera, scene, globe;
    let bloomComposer, finalComposer, bloomPass, finalPass;
    let rafId = 0;
    let running = true;

    const overlays = {};
    let nightLightsMesh = null;

    // ============================
    // Overlay visibility wiring
    // ============================
    function applyVisibility(){
      if (!globe) return;
      for (const k in overlays){
        if (!overlays[k]) continue;
        overlays[k].visible = !!overlayState[k];
      }
      if (nightLightsMesh) nightLightsMesh.visible = !!overlayState.nightLights;
    }

    function setOverlayPillVisuals(){
      // purely reflect preset ‚Äúon‚Äù glows for station group buttons
      syncStationButtons();
    }

    function saveOverlayAndApply(){
      overlayState.stations = true;
      saveJSON(LS.overlays, overlayState);
      applyVisibility();
      setOverlayPillVisuals();
    }

    // ============================
    // Boot
    // ============================
    (async ()=>{
      try{
        setStatusBase("Starting‚Ä¶");
        scene = new THREE.Scene();

        camera = new THREE.PerspectiveCamera(55, innerWidth/innerHeight, 0.1, 5000);
        camera.position.set(0, 0, 4.15);

        renderer = new THREE.WebGLRenderer({ antialias:true, alpha:false, powerPreference: "high-performance" });
        renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));
        renderer.setSize(innerWidth, innerHeight);
        renderer.outputColorSpace = THREE.SRGBColorSpace;
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.15;
        document.body.appendChild(renderer.domElement);

        const ambient = new THREE.AmbientLight(0xffffff, 0.18);
        scene.add(ambient);

        const sunLight = new THREE.DirectionalLight(0xffffff, 1.40);
        sunLight.position.set(5, 1.5, 2.5);
        scene.add(sunLight);

        const BASES = [
          "https://threejs.org/examples/textures/",
          "https://unpkg.com/three@0.161.0/examples/textures/",
          "https://cdn.jsdelivr.net/gh/mrdoob/three.js@r161/examples/textures/"
        ];
        const urls = (path)=>BASES.map(b=>b+path);

        setStatusBase("Loading textures‚Ä¶");

        const dayMap   = await loadTextureWithFallback(urls("planets/earth_atmos_2048.jpg"), makeFallbackEarthDay(), "earth day");
        const nightMap = await loadTextureWithFallback(urls("planets/earth_lights_2048.png"), makeFallbackNight(), "earth night lights");
        const specMap  = await loadTextureWithFallback(urls("planets/earth_specular_2048.jpg"), solidTexture("#000"), "earth specular");
        const cloudMap = await loadTextureWithFallback(urls("planets/earth_clouds_1024.png"), makeFallbackClouds(), "earth clouds");
        const starMap  = await loadTextureWithFallback(urls("galaxy_starfield.png"), makeFallbackStars(), "stars");

        const maxAniso = renderer.capabilities.getMaxAnisotropy ? renderer.capabilities.getMaxAnisotropy() : 1;
        [dayMap, nightMap, specMap, cloudMap, starMap].forEach((t)=>{
          t.anisotropy = maxAniso;
          t.wrapS = t.wrapT = THREE.ClampToEdgeWrapping;
        });

        setStatusBase("Running");

        const starGeo = new THREE.SphereGeometry(90, 64, 64);
        const starMat = new THREE.MeshBasicMaterial({ map: starMap, side: THREE.BackSide });
        scene.add(new THREE.Mesh(starGeo, starMat));

        const earthRadius = 1.0;
        const SEG = 96;

        const earthUniforms = {
          dayMap:    { value: dayMap },
          specMap:   { value: specMap },
          sunDir:    { value: new THREE.Vector3(1,0,0) },
          cameraPos: { value: new THREE.Vector3() }
        };

        const earthMat = new THREE.ShaderMaterial({
          uniforms: earthUniforms,
          vertexShader: `
            varying vec2 vUv;
            varying vec3 vNormalW;
            varying vec3 vPosW;
            void main(){
              vUv = uv;
              vec4 worldPos = modelMatrix * vec4(position, 1.0);
              vPosW = worldPos.xyz;
              vNormalW = normalize(mat3(modelMatrix) * normal);
              gl_Position = projectionMatrix * viewMatrix * worldPos;
            }
          `,
          fragmentShader: `
            precision highp float;
            uniform sampler2D dayMap;
            uniform sampler2D specMap;
            uniform vec3 sunDir;
            uniform vec3 cameraPos;
            varying vec2 vUv;
            varying vec3 vNormalW;
            varying vec3 vPosW;

            vec3 srgbToLinear(vec3 c){ return pow(c, vec3(2.2)); }
            vec3 linearToSrgb(vec3 c){ return pow(max(c,0.0), vec3(1.0/2.2)); }

            void main(){
              vec3 N = normalize(vNormalW);
              vec3 L = normalize(sunDir);
              vec3 V = normalize(cameraPos - vPosW);

              vec3 dayCol = srgbToLinear(texture2D(dayMap, vUv).rgb);

              float lum = dot(dayCol, vec3(0.2126,0.7152,0.0722));
              vec3 sat = mix(vec3(lum), dayCol, 1.15);
              vec3 c = pow(max(sat, 0.0), vec3(0.90));

              float specMask = texture2D(specMap, vUv).r;
              float ndl = dot(N, L);
              float dayAmt = smoothstep(-0.05, 0.15, ndl);

              vec3 nightBase = c * 0.10;
              vec3 col = mix(nightBase, c, dayAmt);

              vec3 H = normalize(L + V);
              float spec = pow(max(dot(N, H), 0.0), 80.0) * specMask * 0.55 * dayAmt;
              col += vec3(spec);

              float rim = pow(1.0 - max(dot(N, V), 0.0), 2.2);
              col += vec3(0.06, 0.11, 0.18) * rim * (0.30 + 0.70 * dayAmt);

              gl_FragColor = vec4(linearToSrgb(col), 1.0);
            }
          `
        });

        const earth = new THREE.Mesh(new THREE.SphereGeometry(earthRadius, SEG, SEG), earthMat);

        const lightsUniforms = {
          nightMap: { value: nightMap },
          sunDir:   { value: new THREE.Vector3(1,0,0) },
          gain:     { value: 2.8 }
        };

        nightLightsMesh = new THREE.Mesh(
          new THREE.SphereGeometry(earthRadius * 1.001, SEG, SEG),
          new THREE.ShaderMaterial({
            uniforms: lightsUniforms,
            transparent: true,
            depthWrite: false,
            blending: THREE.AdditiveBlending,
            vertexShader: `
              varying vec2 vUv;
              varying vec3 vNormalW;
              void main(){
                vUv = uv;
                vNormalW = normalize(mat3(modelMatrix) * normal);
                gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0);
              }
            `,
            fragmentShader: `
              precision highp float;
              uniform sampler2D nightMap;
              uniform vec3 sunDir;
              uniform float gain;
              varying vec2 vUv;
              varying vec3 vNormalW;

              vec3 srgbToLinear(vec3 c){ return pow(c, vec3(2.2)); }
              vec3 linearToSrgb(vec3 c){ return pow(max(c,0.0), vec3(1.0/2.2)); }

              void main(){
                vec3 N = normalize(vNormalW);
                vec3 L = normalize(sunDir);

                float ndl = dot(N, L);
                float dayAmt = smoothstep(-0.05, 0.15, ndl);
                float nightAmt = 1.0 - dayAmt;

                vec3 lights = srgbToLinear(texture2D(nightMap, vUv).rgb) * gain;
                float mask = smoothstep(0.06, 0.36, nightAmt);

                vec3 col = lights * mask;
                float a = clamp(max(max(col.r, col.g), col.b), 0.0, 1.0);
                gl_FragColor = vec4(linearToSrgb(col), a);
              }
            `
          })
        );

        const cloudShadow = new THREE.Mesh(
          new THREE.SphereGeometry(earthRadius * 1.0015, SEG, SEG),
          new THREE.MeshBasicMaterial({
            map: cloudMap,
            color: 0x000000,
            transparent: true,
            opacity: 0.22,
            blending: THREE.MultiplyBlending,
            depthWrite: false
          })
        );

        const clouds = new THREE.Mesh(
          new THREE.SphereGeometry(earthRadius * 1.012, SEG, SEG),
          new THREE.MeshLambertMaterial({
            map: cloudMap,
            transparent: true,
            opacity: 0.95,
            depthWrite: false
          })
        );

        const atmoUniforms = {
          sunDir:    { value: new THREE.Vector3(1,0,0) },
          cameraPos: { value: new THREE.Vector3() }
        };

        const atmosphere = new THREE.Mesh(
          new THREE.SphereGeometry(earthRadius * 1.045, SEG, SEG),
          new THREE.ShaderMaterial({
            uniforms: atmoUniforms,
            transparent: true,
            depthWrite: false,
            blending: THREE.AdditiveBlending,
            side: THREE.BackSide,
            vertexShader: `
              varying vec3 vNormalW;
              varying vec3 vPosW;
              void main(){
                vec4 worldPos = modelMatrix * vec4(position, 1.0);
                vPosW = worldPos.xyz;
                vNormalW = normalize(mat3(modelMatrix) * normal);
                gl_Position = projectionMatrix * viewMatrix * worldPos;
              }
            `,
            fragmentShader: `
              precision highp float;
              uniform vec3 sunDir;
              uniform vec3 cameraPos;
              varying vec3 vNormalW;
              varying vec3 vPosW;

              void main(){
                vec3 N = normalize(vNormalW);
                vec3 L = normalize(sunDir);
                vec3 V = normalize(cameraPos - vPosW);

                float rim = pow(1.0 - max(dot(N, V), 0.0), 3.2);
                float daySide = smoothstep(-0.15, 0.25, dot(N, L));

                vec3 col = vec3(0.20, 0.60, 1.00) * rim * (0.22 + 0.78 * daySide);
                float alpha = rim * (0.16 + 0.62 * daySide);
                gl_FragColor = vec4(col, alpha);
              }
            `
          })
        );

        globe = new THREE.Group();
        globe.add(earth, nightLightsMesh, cloudShadow, clouds, atmosphere);
        scene.add(globe);

        // Build overlays groups
        const overlayKeys = [
          "rhumb222","rhumb42","gc222","gc42",
          "names222","names42",
          "perpLine","perpName",
          "continents","stations","corridors","magField","aurora"
        ];
        overlayKeys.forEach(k=>{
          overlays[k] = new THREE.Group();
          globe.add(overlays[k]);
        });

        const BEAR_222 = 222;
        const BEAR_42  = 42;

        const gc222 = greatCirclePoints(ANCHOR.lat, ANCHOR.lon, BEAR_222, 1.0)
          .map(p => latLonToVec3(p.lat, p.lon, earthRadius*1.012));
        const rh222 = rhumbPoints(ANCHOR.lat, ANCHOR.lon, BEAR_222, 240)
          .map(p => latLonToVec3(p.lat, p.lon, earthRadius*1.012));

        const gc42 = greatCirclePoints(ANCHOR.lat, ANCHOR.lon, BEAR_42, 1.0)
          .map(p => latLonToVec3(p.lat, p.lon, earthRadius*1.012));
        const rh42 = rhumbPoints(ANCHOR.lat, ANCHOR.lon, BEAR_42, 240)
          .map(p => latLonToVec3(p.lat, p.lon, earthRadius*1.012));

        overlays.gc222.add(makeGlowTube(gc222, 0.0032, 0x5bbcff, 0x5bbcff, 1.0, 0.28));
        overlays.rhumb222.add(makeGlowTube(rh222, 0.0032, 0xf6c24a, 0xf6c24a, 1.0, 0.26));
        overlays.gc42.add(makeGlowTube(gc42, 0.0032, 0x5bbcff, 0x5bbcff, 0.55, 0.20));
        overlays.rhumb42.add(makeGlowTube(rh42, 0.0032, 0xf6c24a, 0xf6c24a, 0.55, 0.18));

        function arcFromBearing(bearingDeg){
          const pts = greatCirclePoints(ANCHOR.lat, ANCHOR.lon, bearingDeg, 1.2)
            .filter((_, i) => i > 40 && i < 260)
            .map(p => latLonToVec3(p.lat, p.lon, earthRadius*1.012));
          return makeGlowTube(pts, 0.0026, 0x5bbcff, 0x5bbcff, 1.0, 0.18);
        }
        overlays.perpLine.add(arcFromBearing(132), arcFromBearing(312));

        // Settled labels
        const n222 = makeTextSprite("222 SW", { fontSize: 20, glowBlur: 4, glow:"rgba(246,194,74,0.10)" });
        n222.position.copy(latLonToVec3(18, -18, earthRadius*1.10));
        overlays.names222.add(n222);

        const n42 = makeTextSprite("42 NE", { fontSize: 20, glowBlur: 4, glow:"rgba(91,188,255,0.10)" });
        n42.position.copy(latLonToVec3(-6, 62, earthRadius*1.10));
        overlays.names42.add(n42);

        const pLabel = makeTextSprite("132¬∞ / 312¬∞", { fontSize: 18, glowBlur: 4, glow:"rgba(91,188,255,0.09)" });
        pLabel.position.copy(latLonToVec3(52, 105, earthRadius*1.11));
        overlays.perpName.add(pLabel);

        const CONT = [
          { name:"North America", lat: 45,  lon:-102 },
          { name:"South America", lat:-16,  lon:-60 },
          { name:"Europe",        lat: 52,  lon: 15 },
          { name:"Africa",        lat:  5,  lon: 20 },
          { name:"Asia",          lat: 45,  lon: 95 },
          { name:"Australia",     lat:-25,  lon: 135 },
          { name:"Antarctica",    lat:-80,  lon:  0 }
        ];
        for (const c of CONT){
          const s = makeTextSprite(c.name, { fontSize: 18, glowBlur: 4, glow:"rgba(255,255,255,0.08)" });
          s.position.copy(latLonToVec3(c.lat, c.lon, earthRadius*1.10));
          overlays.continents.add(s);
        }

        const kmToUnit = (km)=> (km/6371)*earthRadius;
        const corridorRadii = [
          { km: 1,  r: kmToUnit(1),  o: 0.16 },
          { km: 5,  r: kmToUnit(5),  o: 0.09 },
          { km: 10, r: kmToUnit(10), o: 0.06 }
        ];
        for (const c of corridorRadii){
          overlays.corridors.add(makeGlowTube(gc222, c.r, 0xf6c24a, 0xf6c24a, 0.0, c.o));
          overlays.corridors.add(makeGlowTube(rh222, c.r, 0xf6c24a, 0xf6c24a, 0.0, c.o*0.9));
          overlays.corridors.add(makeGlowTube(gc42, c.r, 0x5bbcff, 0x5bbcff, 0.0, c.o*0.8));
          overlays.corridors.add(makeGlowTube(rh42, c.r, 0x5bbcff, 0x5bbcff, 0.0, c.o*0.75));
        }

        function makeStationMarker(label, lat, lon, color=0x7fffd4){
          const g = new THREE.Group();
          const p = latLonToVec3(lat, lon, earthRadius*1.02);

          const pin = new THREE.Mesh(new THREE.SphereGeometry(0.010, 18, 18),
            new THREE.MeshBasicMaterial({ color, transparent:true, opacity:0.95 })
          );
          pin.position.copy(p);

          const glow = new THREE.Mesh(new THREE.SphereGeometry(0.020, 18, 18),
            new THREE.MeshBasicMaterial({ color, transparent:true, opacity:0.16, blending:THREE.AdditiveBlending, depthWrite:false })
          );
          glow.position.copy(p);

          const tag = makeTextSprite(label, { fontSize: 18, glowBlur: 4, glow:"rgba(255,255,255,0.10)" });
          tag.position.copy(latLonToVec3(lat, lon, earthRadius*1.12));

          g.add(glow, pin, tag);
          return g;
        }
        overlays.stations.add(makeStationMarker(ANCHOR.name, ANCHOR.lat, ANCHOR.lon, 0x7fffd4));
        stationTextEl.textContent = `${ANCHOR.name} @ ${fmtDMS(ANCHOR.lat, ANCHOR.lon)}`;

        function makeDipoleFieldLines(){
          const g = new THREE.Group();
          const col = 0x5bbcff;
          const axis = new THREE.Vector3(0,1,0);
          const Ls = [1.6, 2.2, 3.2, 4.6];

          for (const L of Ls){
            const pts = [];
            for (let t=-80; t<=80; t+=1.2){
              const Œ∏ = (90 - t) * DEG;
              const r = L * Math.sin(Œ∏)*Math.sin(Œ∏);
              const rr = earthRadius * r;
              if (rr < earthRadius*1.04) continue;
              const x = rr * Math.sin(Œ∏);
              const y = rr * Math.cos(Œ∏);
              pts.push(new THREE.Vector3(x, y, 0));
            }

            const longitudes = 10;
            for (let i=0; i<longitudes; i++){
              const a = (i/longitudes) * Math.PI*2;
              const ring = pts.map(p=>{
                const len = p.length();
                const v = p.clone().applyAxisAngle(axis, a);
                return v.normalize().multiplyScalar(len);
              });
              const ringClamped = ring.filter(v => v.length() < earthRadius*7.5);
              g.add(makeGlowTube(ringClamped, 0.0014, col, col, 0.0, 0.055));
            }
          }
          return g;
        }
        overlays.magField.add(makeDipoleFieldLines());

        function makeAuroraBelt(latDeg=67, color=0xa078ff){
          const g = new THREE.Group();
          for (const lat of [latDeg, -latDeg]){
            const pts = [];
            for (let lon=-180; lon<=180; lon+=2) pts.push(latLonToVec3(lat, lon, earthRadius*1.05));
            g.add(makeGlowTube(pts, 0.0026, color, color, 0.0, 0.11));
          }
          return g;
        }
        overlays.aurora.add(makeAuroraBelt(67));

        // Bloom setup
        const BLOOM_LAYER = 1;
        const bloomLayer = new THREE.Layers(); bloomLayer.set(BLOOM_LAYER);

        nightLightsMesh.layers.enable(BLOOM_LAYER);
        atmosphere.layers.enable(BLOOM_LAYER);
        Object.values(overlays).forEach(g=>{
          g.traverse(o => o.layers && o.layers.enable(BLOOM_LAYER));
        });

        const darkMaterial = new THREE.MeshBasicMaterial({ color:"black" });
        const materials = new Map();
        function darkenNonBloom(obj){
          if (obj.isMesh && !bloomLayer.test(obj.layers)){
            materials.set(obj.uuid, obj.material);
            obj.material = darkMaterial;
          }
        }
        function restoreMaterial(obj){
          if (materials.has(obj.uuid)){
            obj.material = materials.get(obj.uuid);
            materials.delete(obj.uuid);
          }
        }

        const renderScene = new RenderPass(scene, camera);

        bloomPass = new UnrealBloomPass(new THREE.Vector2(innerWidth, innerHeight), 1.10, 0.85, 0.10);
        bloomComposer = new EffectComposer(renderer);
        bloomComposer.renderToScreen = false;
        bloomComposer.addPass(renderScene);
        bloomComposer.addPass(bloomPass);

        finalPass = new ShaderPass({
          uniforms: { tDiffuse: { value: null }, bloomTexture: { value: null } },
          vertexShader: `varying vec2 vUv; void main(){ vUv=uv; gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0);} `,
          fragmentShader: `uniform sampler2D tDiffuse; uniform sampler2D bloomTexture; varying vec2 vUv;
            void main(){ gl_FragColor = texture2D(tDiffuse,vUv) + texture2D(bloomTexture,vUv); }`
        });

        finalComposer = new EffectComposer(renderer);
        finalComposer.addPass(renderScene);
        finalComposer.addPass(finalPass);
        finalComposer.addPass(new OutputPass());

        function renderBloom(){
          scene.traverse(darkenNonBloom);
          bloomComposer.render();
          finalPass.uniforms.bloomTexture.value = bloomComposer.readBuffer.texture;
          scene.traverse(restoreMaterial);
        }

        // Apply initial overlay state
        overlayState.stations = true;
        applyVisibility();
        syncStationButtons();

        // Interaction
        let dragging=false, lastX=0, lastY=0, velY=0, velX=0;
        const AUTO_SPIN=0.0012, DRAG_SENS=0.0065, PITCH_SENS=0.0048, DAMPING=0.92, MAX_PITCH=0.55;

        let pinching=false, pinchStartDist=0, pinchStartZ=camera.position.z;
        const Z_MIN=2.2, Z_MAX=8.0;

        function getPoint(e){
          if (e.touches && e.touches.length) return { x:e.touches[0].clientX, y:e.touches[0].clientY };
          return { x:e.clientX, y:e.clientY };
        }
        function dist2(t1,t2){
          const dx=t1.clientX-t2.clientX, dy=t1.clientY-t2.clientY;
          return Math.sqrt(dx*dx+dy*dy);
        }

        const el = renderer.domElement;

        function down(e){
          if (isUIEventTarget(e.target)) return;

          if (e.touches && e.touches.length === 2){
            pinching=true;
            pinchStartDist = dist2(e.touches[0], e.touches[1]);
            pinchStartZ = camera.position.z;
            return;
          }
          dragging=true;
          const p=getPoint(e);
          lastX=p.x; lastY=p.y;
        }

        function move(e){
          if (isUIEventTarget(e.target)) return;

          if (pinching && e.touches && e.touches.length === 2){
            const d = dist2(e.touches[0], e.touches[1]);
            const ratio = pinchStartDist > 0 ? (pinchStartDist / d) : 1.0;
            camera.position.z = clamp(pinchStartZ * ratio, Z_MIN, Z_MAX);
            return;
          }

          if(!dragging) return;
          const p=getPoint(e);
          const dx=p.x-lastX, dy=p.y-lastY;
          lastX=p.x; lastY=p.y;

          globe.rotation.y += dx*DRAG_SENS;
          globe.rotation.x = clamp(globe.rotation.x + dy*PITCH_SENS, -MAX_PITCH, MAX_PITCH);

          velY = dx*DRAG_SENS;
          velX = dy*PITCH_SENS;
        }

        function up(){ dragging=false; pinching=false; }

        el.addEventListener("touchstart", down, { passive:true });
        el.addEventListener("touchmove", move, { passive:true });
        el.addEventListener("touchend", up, { passive:true });
        el.addEventListener("mousedown", down);
        window.addEventListener("mousemove", move);
        window.addEventListener("mouseup", up);

        window.addEventListener("wheel", (e)=>{
          if (isUIEventTarget(e.target)) return;
          camera.position.z = clamp(camera.position.z + (e.deltaY * 0.0025), Z_MIN, Z_MAX);
        }, { passive:true });

        let resizeTimer = 0;
        function doResize(){
          if (!renderer || !camera) return;

          const w = Math.max(1, window.innerWidth);
          const h = Math.max(1, window.innerHeight);

          camera.aspect = w/h;
          camera.updateProjectionMatrix();

          renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));
          renderer.setSize(w, h, false);

          bloomComposer.setSize(w, h);
          finalComposer.setSize(w, h);
          bloomPass.setSize(w, h);
        }

        function scheduleResize(){
          clearTimeout(resizeTimer);
          resizeTimer = setTimeout(()=> requestAnimationFrame(doResize), 160);
        }

        window.addEventListener("resize", scheduleResize, { passive:true });
        window.addEventListener("orientationchange", scheduleResize, { passive:true });

        document.addEventListener("visibilitychange", ()=>{
          running = !document.hidden;
          if (running && !rafId) animate();
        });

        const sunDrift = 0.00005;
        const cloudSpin = 0.0020;

        function animate(){
          if (!running){ rafId = 0; return; }
          rafId = requestAnimationFrame(animate);

          clouds.rotation.y += cloudSpin;
          cloudShadow.rotation.y += cloudSpin + 0.00015;

          if(!dragging && !pinching){
            globe.rotation.y += AUTO_SPIN + velY;
            globe.rotation.x = clamp(globe.rotation.x + velX, -MAX_PITCH, MAX_PITCH);
            velY *= DAMPING;
            velX *= DAMPING;
          }

          sunLight.position.applyAxisAngle(new THREE.Vector3(0,1,0), sunDrift);
          const sunDir = sunLight.position.clone().normalize();

          earthUniforms.sunDir.value.copy(sunDir);
          earthUniforms.cameraPos.value.copy(camera.position);
          lightsUniforms.sunDir.value.copy(sunDir);
          atmoUniforms.sunDir.value.copy(sunDir);
          atmoUniforms.cameraPos.value.copy(camera.position);

          renderBloom();
          finalComposer.render();
        }
        animate();

      } catch (err){
        showError("Top-level error:\n" + (err?.stack || err?.message || err));
      }
    })();

    // ============================
    // Keep station buttons synced on load
    // ============================
    syncStationButtons();

  </script>
</body>
</html>
